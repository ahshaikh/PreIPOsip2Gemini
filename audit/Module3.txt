PHASE 3: AUDIT - Wallet & Ledger Module
Focus Files:

Backend: WalletController.php, Wallet.php, WalletService.php, Transaction.php, WalletDepositRequest.php.

Frontend: app/(user)/wallet/page.tsx.

1. Purpose
This module manages the internal financial ledger of the user. It handles the "Wallet" entity, tracks the balance (Available vs. Locked), records all transactions (Credits/Debits), and manages the locking mechanism for withdrawals. It is the financial heart of the application.

2. Architectural Flaws
Float Type Hinting (Financial Risk): WalletService methods accept float $amount.

Issue: PHP floats utilize IEEE 754 floating-point arithmetic, which leads to precision errors (e.g., 0.1 + 0.2 is not exactly 0.3). While the database updates (increment/decrement) happen at the SQL level (which is safe), passing values as floats in PHP services invites rounding errors before the query is built.

Fix: Change type hints to string or use a library like Brick\Money.

Frontend/Backend Disconnect: The Frontend WalletPage contains a fully functional "Add Money" UI that calls /user/wallet/add-money. However, the backend WalletController::initiateDeposit explicitly returns 501 Not Implemented. This is a broken user journey.

Incomplete Statement Logic: The downloadStatement method allows downloading a PDF but hard-stops at 1,000 records. There is no fallback flow (e.g., "Email me a CSV") for users with high transaction volume, effectively locking them out of their full history.

3. Anti-Patterns
Magic Strings: Transaction types like 'bonus_credit', 'admin_adjustment', 'withdrawal_request', 'reversal' are hardcoded in the Controller, Service, and Frontend.

Risk: A typo in one file ('bonus_credits' vs 'bonus_credit') will break reporting or filtering without throwing a clear error.

Validation Logic in Service: WalletService throws generic \Exception for insufficient funds. It should throw a custom InsufficientBalanceException so the Controller can catch it specifically and return a 422 status code, separating business logic errors from system errors.

4. Security Vulnerabilities
Mass Assignment (Potential): In WalletController::requestWithdrawal, validated['bank_details'] is passed directly to createWithdrawalRecord. If WithdrawalService doesn't strictly filter keys, a user might inject fields like admin_note or status if those columns exist on the withdrawal model.

Lack of Idempotency: The requestWithdrawal endpoint is not idempotent. If a user double-clicks the submit button (and the frontend prevention fails or is bypassed), two withdrawal requests could be generated before the first one completes, potentially locking double the funds if the balance allows.

5. Missing Tests / Weak Strategy
Concurrency Testing: While the code uses lockForUpdate(), there is no evidence of a test case that simulates concurrent requests (e.g., firing 5 withdrawal requests simultaneously) to prove the locking actually works and prevents negative balances.

PDF Generation: No tests for the PDF generation limits (e.g., what happens if description contains special characters or emojis that might break DomPDF).

6. Performance Bottlenecks
PDF Memory Usage: Even with cursor(), DomPDF builds the entire document structure in memory before rendering. For 1,000 complex rows, this is still heavy.

Fix: Offload PDF generation to a queue (GenerateStatementJob) and notify the user when ready, or switch to a streaming CSV for larger datasets.

7. Poor Abstractions
Wallet Initialization: The wallet creation logic exists inside WalletController::show (if (!$wallet) ...). This "lazy creation" logic should be in a WalletRepository or an Event Listener on User Registration (UserCreated -> CreateWallet). Putting it in the show method means a user has no wallet until they visit the dashboard.

8. Inconsistencies
Naming: Frontend uses "Add Money", Backend uses "Deposit".

Response Structure: withdrawals endpoint returns paginated object directly, while show returns ['wallet' => ..., 'transactions' => ...].

Score: 8.5 / 10
Priority Fix Roadmap (Phase 3)
High (Architecture): Replace float $amount with string $amount in WalletService and use bcmath functions (or simply validate string format) to ensure financial precision.

High (UX/Logic): Implement the "Add Money" backend logic (integration with Payment Gateway) OR hide the button in the frontend until ready.

Medium (Refactor): Create a TransactionType Enum to replace magic strings.

Medium (Performance): Move PDF generation to a Queue for any date range > 30 days.

Low (Cleanup): Move Wallet creation to the UserRegistered event listener.

Refactored Folder Structure Recommendation (Backend)
app/
├── Enums/
│   └── TransactionType.php      <-- (New Enum)
├── Services/
│   ├── Financial/
│   │   ├── WalletService.php
│   │   ├── WithdrawalService.php
│   │   ├── StatementGenerator.php <-- (Extract PDF logic)
│   │   └── Ledger/
│   │       └── DoubleEntryRecorder.php
Comprehensive Report
The Wallet module is robustly designed with lockForUpdate() correctly implemented to handle concurrency—a rare find in many projects. The separation between the Controller and Service is clean. However, the reliance on PHP floats is a dormant risk, and the unfinished "Deposit" feature creates a broken experience. The PDF statement generation is safe from crashing the server (due to limits) but offers a poor user experience for power users.