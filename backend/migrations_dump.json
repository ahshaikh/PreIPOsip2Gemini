[
    {
        "name": "0001_01_01_000000_create_users_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\0001_01_01_000000_create_users_table.php",
        "content": "<?php\n// V-PHASE1-1730-002 | V-FINAL-1730-609 (Consolidated)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('users', function (Blueprint $table) {\n            $table->id();\n            $table->string('google_id')->nullable()->unique();\n            $table->string('username')->unique();\n            $table->string('email')->unique();\n            $table->string('mobile')->unique();\n            $table->timestamp('email_verified_at')->nullable();\n            $table->timestamp('mobile_verified_at')->nullable();\n            $table->string('password')->nullable();\n            \n            // 2FA Fields\n            $table->text('two_factor_secret')->nullable();\n            $table->text('two_factor_recovery_codes')->nullable();\n            $table->timestamp('two_factor_confirmed_at')->nullable();\n            \n            $table->string('referral_code')->unique();\n            $table->foreignId('referred_by')->nullable()->constrained('users')->onDelete('set null');\n            \n            $table->string('status')->default('pending'); // pending, active, suspended, blocked\n            $table->string('avatar_url')->nullable();\n            $table->timestamp('last_login_at')->nullable();\n            $table->string('last_login_ip')->nullable();\n            \n            $table->rememberToken();\n            $table->timestamps();\n            $table->softDeletes();\n        });\n\n// V-PHASE1-1730-003\n        // Dependent Tables\n        Schema::create('user_profiles', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->string('first_name')->nullable();\n            $table->string('last_name')->nullable();\n            $table->date('dob')->nullable();\n            $table->string('gender')->nullable();\n            $table->text('address_line_1')->nullable();\n            $table->text('address_line_2')->nullable();\n            $table->string('city')->nullable();\n            $table->string('state')->nullable();\n            $table->string('pincode')->nullable();\n            $table->string('country')->default('India');\n            $table->timestamps();\n        });\n\n// V-PHASE1-1730-004\n        Schema::create('user_kyc', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->string('pan_number')->nullable();\n            $table->string('aadhaar_number')->nullable();\n            $table->string('demat_account')->nullable();\n            $table->string('bank_account')->nullable();\n            $table->string('bank_ifsc')->nullable();\n            $table->string('status')->default('pending'); // pending, submitted, verified, rejected, processing\n            $table->text('rejection_reason')->nullable();\n            $table->foreignId('verified_by')->nullable()->constrained('users');\n            $table->timestamp('verified_at')->nullable();\n            $table->timestamp('submitted_at')->nullable();\n            $table->timestamps();\n        });\n        \n// V-PHASE1-1730-005\n        Schema::create('kyc_documents', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_kyc_id')->constrained('user_kyc')->onDelete('cascade');\n            $table->string('doc_type');\n            $table->string('file_path');\n            $table->string('file_name');\n            $table->string('mime_type');\n            $table->string('status')->default('pending'); // pending, approved, rejected\n            $table->string('processing_status')->nullable(); // api status\n            $table->foreignId('verified_by')->nullable()->constrained('users');\n            $table->timestamp('verified_at')->nullable();\n            $table->text('verification_notes')->nullable();\n            $table->timestamps();\n        });\n        \n        Schema::create('password_histories', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->string('password_hash');\n            $table->timestamps();\n            $table->index(['user_id', 'created_at']);\n        });\n\n// V-PHASE1-1730-007\n        Schema::create('otps', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->string('type'); // email, mobile, password_reset\n            $table->string('otp_code');\n            $table->integer('attempts')->default(0);\n            $table->boolean('blocked')->default(false);\n            $table->timestamp('expires_at');\n            $table->timestamp('last_sent_at')->nullable();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('otps');\n        Schema::dropIfExists('password_histories');\n        Schema::dropIfExists('kyc_documents');\n        Schema::dropIfExists('user_kyc');\n        Schema::dropIfExists('user_profiles');\n        Schema::dropIfExists('users');\n    }\n};"
    },
    {
        "name": "0001_01_01_000001_create_cache_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\0001_01_01_000001_create_cache_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     */\n    public function up(): void\n    {\n        Schema::create('cache', function (Blueprint $table) {\n            $table->string('key')->primary();\n            $table->mediumText('value');\n            $table->integer('expiration');\n        });\n\n        Schema::create('cache_locks', function (Blueprint $table) {\n            $table->string('key')->primary();\n            $table->string('owner');\n            $table->integer('expiration');\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void\n    {\n        Schema::dropIfExists('cache');\n        Schema::dropIfExists('cache_locks');\n    }\n};\n"
    },
    {
        "name": "0001_01_01_000002_create_jobs_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\0001_01_01_000002_create_jobs_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     */\n    public function up(): void\n    {\n        Schema::create('jobs', function (Blueprint $table) {\n            $table->id();\n            $table->string('queue')->index();\n            $table->longText('payload');\n            $table->unsignedTinyInteger('attempts');\n            $table->unsignedInteger('reserved_at')->nullable();\n            $table->unsignedInteger('available_at');\n            $table->unsignedInteger('created_at');\n        });\n\n        Schema::create('job_batches', function (Blueprint $table) {\n            $table->string('id')->primary();\n            $table->string('name');\n            $table->integer('total_jobs');\n            $table->integer('pending_jobs');\n            $table->integer('failed_jobs');\n            $table->longText('failed_job_ids');\n            $table->mediumText('options')->nullable();\n            $table->integer('cancelled_at')->nullable();\n            $table->integer('created_at');\n            $table->integer('finished_at')->nullable();\n        });\n\n        Schema::create('failed_jobs', function (Blueprint $table) {\n            $table->id();\n            $table->string('uuid')->unique();\n            $table->text('connection');\n            $table->text('queue');\n            $table->longText('payload');\n            $table->longText('exception');\n            $table->timestamp('failed_at')->useCurrent();\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void\n    {\n        Schema::dropIfExists('jobs');\n        Schema::dropIfExists('job_batches');\n        Schema::dropIfExists('failed_jobs');\n    }\n};\n"
    },
    {
        "name": "2025_11_11_000105_create_activity_logs_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000105_create_activity_logs_table.php",
        "content": "<?php\n// V-PHASE1-1730-006\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('activity_logs', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->nullable()->constrained()->onDelete('cascade');\n            $table->string('action'); // e.g., 'auth.login', 'kyc.submitted'\n            $table->string('target_type')->nullable(); // e.g., App\\Models\\UserKyc\n            $table->unsignedBigInteger('target_id')->nullable();\n            $table->text('description')->nullable();\n            $table->ipAddress('ip_address')->nullable();\n            $table->string('user_agent')->nullable();\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('activity_logs');\n    }\n};"
    },
    {
        "name": "2025_11_11_000200_create_settings_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000200_create_settings_table.php",
        "content": "<?php\n// V-PHASE2-1730-024 (Created) | V-FINAL-1730-610 (Consolidated)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('settings', function (Blueprint $table) {\n            $table->id();\n            $table->string('key')->unique();\n            $table->longText('value')->nullable();\n            $table->string('type')->default('string');\n            $table->string('group')->default('system');\n            $table->foreignId('updated_by')->nullable()->constrained('users')->onDelete('set null');\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('settings');\n    }\n};"
    },
    {
        "name": "2025_11_11_000201_create_plans_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000201_create_plans_table.php",
        "content": "<?php\n// V-PHASE2-1730-025 (Created) | V-FINAL-1730-611 (Consolidated) | V-FINAL-1730-619 (Timestamps Fix)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('plans', function (Blueprint $table) {\n            $table->id();\n            $table->string('name');\n            $table->string('slug')->unique();\n            $table->string('razorpay_plan_id')->nullable();\n            $table->decimal('monthly_amount', 10, 2);\n            $table->integer('duration_months')->default(36);\n            $table->text('description')->nullable();\n            $table->boolean('is_active')->default(true);\n            $table->boolean('is_featured')->default(false);\n            $table->integer('display_order')->default(0);\n            \n            // Scheduling\n            $table->timestamp('available_from')->nullable();\n            $table->timestamp('available_until')->nullable();\n\n            // Rules\n            $table->integer('max_subscriptions_per_user')->default(1);\n            $table->boolean('allow_pause')->default(true);\n            $table->integer('max_pause_count')->default(3);\n            $table->integer('max_pause_duration_months')->default(3);\n\n            $table->timestamps();\n            $table->softDeletes();\n        });\n\n// V-PHASE2-1730-027\n        Schema::create('plan_features', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('plan_id')->constrained()->onDelete('cascade');\n            $table->string('feature_text');\n            $table->string('icon')->nullable();\n            $table->integer('display_order')->default(0);\n            $table->timestamps(); // <-- THE MISSING LINE\n        });\n\n// V-PHASE2-1730-026\n        Schema::create('plan_configs', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('plan_id')->constrained()->onDelete('cascade');\n            $table->string('config_key');\n            $table->json('value');\n            $table->timestamps();\n            \n            $table->unique(['plan_id', 'config_key']);\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('plan_configs');\n        Schema::dropIfExists('plan_features');\n        Schema::dropIfExists('plans');\n    }\n};"
    },
    {
        "name": "2025_11_11_000204_create_products_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000204_create_products_table.php",
        "content": "<?php\n// V-PHASE2-1730-028 (Created) | V-FINAL-1730-494 (Advanced Pricing) | V-FINAL-1730-612 (Consolidated)\n// NOTE: This migration is DEPRECATED. Individual tables now have their own migration files.\n// Keeping for backwards compatibility - uses hasTable() checks to prevent duplicate creation.\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        // Main products table\n        if (!Schema::hasTable('products')) {\n            Schema::create('products', function (Blueprint $table) {\n                $table->id();\n                $table->string('name');\n                $table->string('slug')->unique();\n                $table->string('sector')->nullable();\n\n                // Pricing\n                $table->decimal('face_value_per_unit', 10, 2);\n                $table->decimal('current_market_price', 10, 2)->nullable();\n                $table->timestamp('last_price_update')->nullable();\n                $table->boolean('auto_update_price')->default(false);\n                $table->string('price_api_endpoint')->nullable();\n\n                $table->decimal('min_investment', 10, 2);\n                $table->date('expected_ipo_date')->nullable();\n                $table->string('status')->default('active');\n\n                // Compliance\n                $table->string('sebi_approval_number')->nullable();\n                $table->date('sebi_approval_date')->nullable();\n                $table->text('compliance_notes')->nullable();\n                $table->text('regulatory_warnings')->nullable();\n\n                $table->boolean('is_featured')->default(false);\n                $table->integer('display_order')->default(0);\n\n                $table->json('description')->nullable();\n\n                $table->timestamps();\n                $table->softDeletes();\n            });\n        }\n\n        // Dependent tables - now in separate migrations\n        if (!Schema::hasTable('product_highlights')) {\n            Schema::create('product_highlights', function (Blueprint $table) {\n                $table->id();\n                $table->foreignId('product_id')->constrained()->onDelete('cascade');\n                $table->string('content');\n                $table->integer('display_order')->default(0);\n            });\n        }\n\n        if (!Schema::hasTable('product_founders')) {\n            Schema::create('product_founders', function (Blueprint $table) {\n                $table->id();\n                $table->foreignId('product_id')->constrained()->onDelete('cascade');\n                $table->string('name');\n                $table->string('title');\n                $table->string('photo_url')->nullable();\n                $table->string('linkedin_url')->nullable();\n            });\n        }\n\n        if (!Schema::hasTable('product_funding_rounds')) {\n            Schema::create('product_funding_rounds', function (Blueprint $table) {\n                $table->id();\n                $table->foreignId('product_id')->constrained()->onDelete('cascade');\n                $table->string('round_name');\n                $table->date('date');\n                $table->decimal('amount', 14, 2);\n                $table->decimal('valuation', 14, 2);\n                $table->text('investors');\n            });\n        }\n\n        if (!Schema::hasTable('product_key_metrics')) {\n            Schema::create('product_key_metrics', function (Blueprint $table) {\n                $table->id();\n                $table->foreignId('product_id')->constrained()->onDelete('cascade');\n                $table->string('metric_name');\n                $table->string('value');\n                $table->string('unit');\n            });\n        }\n\n        if (!Schema::hasTable('product_risk_disclosures')) {\n            Schema::create('product_risk_disclosures', function (Blueprint $table) {\n                $table->id();\n                $table->foreignId('product_id')->constrained()->onDelete('cascade');\n                $table->string('risk_category');\n                $table->string('severity');\n                $table->string('risk_title');\n                $table->text('risk_description');\n                $table->integer('display_order')->default(0);\n            });\n        }\n\n        if (!Schema::hasTable('product_price_histories')) {\n            Schema::create('product_price_histories', function (Blueprint $table) {\n                $table->id();\n                $table->foreignId('product_id')->constrained()->onDelete('cascade');\n                $table->decimal('price', 10, 2);\n                $table->date('recorded_at');\n                $table->timestamps();\n                $table->unique(['product_id', 'recorded_at']);\n            });\n        }\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('product_price_histories');\n        Schema::dropIfExists('product_risk_disclosures');\n        Schema::dropIfExists('product_key_metrics');\n        Schema::dropIfExists('product_funding_rounds');\n        Schema::dropIfExists('product_founders');\n        Schema::dropIfExists('product_highlights');\n        Schema::dropIfExists('products');\n    }\n};"
    },
    {
        "name": "2025_11_11_000204a_create_product_highlights_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000204a_create_product_highlights_table.php",
        "content": "<?php\n// Split from: 2025_11_11_000204_create_products_table.php\n// Table: product_highlights\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        if (!Schema::hasTable('product_highlights')) {\n            Schema::create('product_highlights', function (Blueprint $table) {\n                $table->id();\n                $table->foreignId('product_id')->constrained()->onDelete('cascade');\n                $table->string('content');\n                $table->integer('display_order')->default(0);\n            });\n        }\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('product_highlights');\n    }\n};\n"
    },
    {
        "name": "2025_11_11_000204b_create_product_founders_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000204b_create_product_founders_table.php",
        "content": "<?php\n// Split from: 2025_11_11_000204_create_products_table.php\n// Table: product_founders\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        if (!Schema::hasTable('product_founders')) {\n            Schema::create('product_founders', function (Blueprint $table) {\n                $table->id();\n                $table->foreignId('product_id')->constrained()->onDelete('cascade');\n                $table->string('name');\n                $table->string('title');\n                $table->string('photo_url')->nullable();\n                $table->string('linkedin_url')->nullable();\n            });\n        }\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('product_founders');\n    }\n};\n"
    },
    {
        "name": "2025_11_11_000204c_create_product_funding_rounds_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000204c_create_product_funding_rounds_table.php",
        "content": "<?php\n// Split from: 2025_11_11_000204_create_products_table.php\n// Table: product_funding_rounds\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        if (!Schema::hasTable('product_funding_rounds')) {\n            Schema::create('product_funding_rounds', function (Blueprint $table) {\n                $table->id();\n                $table->foreignId('product_id')->constrained()->onDelete('cascade');\n                $table->string('round_name');\n                $table->date('date');\n                $table->decimal('amount', 14, 2);\n                $table->decimal('valuation', 14, 2);\n                $table->text('investors');\n            });\n        }\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('product_funding_rounds');\n    }\n};\n"
    },
    {
        "name": "2025_11_11_000204d_create_product_key_metrics_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000204d_create_product_key_metrics_table.php",
        "content": "<?php\n// Split from: 2025_11_11_000204_create_products_table.php\n// Table: product_key_metrics\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        if (!Schema::hasTable('product_key_metrics')) {\n            Schema::create('product_key_metrics', function (Blueprint $table) {\n                $table->id();\n                $table->foreignId('product_id')->constrained()->onDelete('cascade');\n                $table->string('metric_name');\n                $table->string('value');\n                $table->string('unit');\n            });\n        }\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('product_key_metrics');\n    }\n};\n"
    },
    {
        "name": "2025_11_11_000204e_create_product_risk_disclosures_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000204e_create_product_risk_disclosures_table.php",
        "content": "<?php\n// Split from: 2025_11_11_000204_create_products_table.php\n// Table: product_risk_disclosures\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        if (!Schema::hasTable('product_risk_disclosures')) {\n            Schema::create('product_risk_disclosures', function (Blueprint $table) {\n                $table->id();\n                $table->foreignId('product_id')->constrained()->onDelete('cascade');\n                $table->string('risk_category');\n                $table->string('severity');\n                $table->string('risk_title');\n                $table->text('risk_description');\n                $table->integer('display_order')->default(0);\n            });\n        }\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('product_risk_disclosures');\n    }\n};\n"
    },
    {
        "name": "2025_11_11_000204f_create_product_price_histories_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000204f_create_product_price_histories_table.php",
        "content": "<?php\n// Split from: 2025_11_11_000204_create_products_table.php\n// Table: product_price_histories\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        if (!Schema::hasTable('product_price_histories')) {\n            Schema::create('product_price_histories', function (Blueprint $table) {\n                $table->id();\n                $table->foreignId('product_id')->constrained()->onDelete('cascade');\n                $table->decimal('price', 10, 2);\n                $table->date('recorded_at');\n                $table->timestamps();\n                $table->unique(['product_id', 'recorded_at']);\n            });\n        }\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('product_price_histories');\n    }\n};\n"
    },
    {
        "name": "2025_11_11_000205_create_bulk_purchases_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000205_create_bulk_purchases_table.php",
        "content": "<?php\n// V-PHASE2-1730-029\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     * This is the core business model inventory table.\n     */\n    public function up(): void\n    {\n        Schema::create('bulk_purchases', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('product_id')->constrained()->onDelete('restrict');\n            $table->foreignId('admin_id')->constrained('users')->onDelete('restrict');\n            \n            $table->decimal('face_value_purchased', 14, 2);\n            $table->decimal('actual_cost_paid', 14, 2);\n            $table->decimal('discount_percentage', 5, 2);\n            $table->decimal('extra_allocation_percentage', 5, 2);\n            \n            $table->decimal('total_value_received', 14, 2); // (face_value * (1 + extra_alloc/100))\n            $table->decimal('value_remaining', 14, 2); // Starts as total_value_received, decrements\n            \n            $table->string('seller_name')->nullable();\n            $table->date('purchase_date');\n            $table->text('notes')->nullable();\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('bulk_purchases');\n    }\n};"
    },
    {
        "name": "2025_11_11_000207_create_menus_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000207_create_menus_table.php",
        "content": "<?php\n// V-PHASE2-1730-031\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('menus', function (Blueprint $table) {\n            $table->id();\n            $table->string('name'); // e.g., \"Header Navigation\"\n            $table->string('slug')->unique(); // e.g., \"header-nav\"\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('menus');\n    }\n};"
    },
    {
        "name": "2025_11_11_000208_create_menu_items_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000208_create_menu_items_table.php",
        "content": "<?php\n// V-PHASE2-1730-032\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('menu_items', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('menu_id')->constrained()->onDelete('cascade');\n            $table->string('label');\n            $table->string('url');\n            $table->foreignId('parent_id')->nullable()->constrained('menu_items')->onDelete('cascade');\n            $table->integer('display_order')->default(0);\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('menu_items');\n    }\n};"
    },
    {
        "name": "2025_11_11_000209_create_email_templates_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000209_create_email_templates_table.php",
        "content": "<?php\n// V-PHASE2-1730-033\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('email_templates', function (Blueprint $table) {\n            $table->id();\n            $table->string('name'); // e.g., \"Welcome Email\"\n            $table->string('slug')->unique(); // e.g., \"auth.welcome\"\n            $table->string('subject');\n            $table->longText('body'); // Storing HTML content\n            $table->json('variables')->nullable(); // Hint for available variables\n            $table->boolean('is_active')->default(true); // <-- REQUIRED FIX\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('email_templates');\n    }\n};\n"
    },
    {
        "name": "2025_11_11_000210_create_sms_templates_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000210_create_sms_templates_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('sms_templates', function (Blueprint $table) {\n            $table->id();\n            $table->string('slug')->unique(); // e.g., \"otp\"\n            $table->string('name'); // e.g., \"OTP Verification\"\n            $table->longText('content'); // <-- REQUIRED FIX\n            $table->json('variables')->nullable(); // [\"otp\"]\n            $table->boolean('is_active')->default(true); // <-- REQUIRED FIX\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('sms_templates');\n    }\n};\n"
    },
    {
        "name": "2025_11_11_000211_create_feature_flags_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000211_create_feature_flags_table.php",
        "content": "<?php\n// V-PHASE2-1730-035\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('feature_flags', function (Blueprint $table) {\n            $table->id();\n            $table->string('key')->unique(); // e.g., \"new-homepage\"\n            $table->string('name'); // e.g., \"New Homepage Design\"\n\t    $table->text('description')->nullable();      // <-- ADD THIS\n            $table->boolean('is_enabled')->default(false);\n            $table->integer('rollout_percentage')->default(0);\n            $table->json('target_users')->nullable(); // Store array of user IDs\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('feature_flags');\n    }\n};"
    },
    {
        "name": "2025_11_11_000300_create_subscriptions_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000300_create_subscriptions_table.php",
        "content": "<?php\n// V-PHASE3-1730-061 (Created) | V-FINAL-1730-613 (Consolidated)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('subscriptions', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->foreignId('plan_id')->constrained()->onDelete('restrict');\n            $table->decimal('amount', 10, 2); // The actual amount\n            $table->string('subscription_code')->unique();\n            $table->string('razorpay_subscription_id')->nullable();\n            \n            $table->string('status')->default('active'); // active, paused, cancelled, completed\n            $table->boolean('is_auto_debit')->default(false);\n            \n            $table->date('start_date');\n            $table->date('end_date');\n            $table->date('next_payment_date');\n            \n            $table->decimal('bonus_multiplier', 5, 2)->default(1.00);\n            $table->integer('consecutive_payments_count')->default(0);\n            \n            // Pause Fields\n            $table->integer('pause_count')->default(0);\n            $table->date('pause_start_date')->nullable();\n            $table->date('pause_end_date')->nullable();\n            \n            // Cancel Fields\n            $table->timestamp('cancelled_at')->nullable();\n            $table->text('cancellation_reason')->nullable();\n            \n            $table->timestamps();\n            $table->softDeletes();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('subscriptions');\n    }\n};"
    },
    {
        "name": "2025_11_11_000301_create_payments_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000301_create_payments_table.php",
        "content": "<?php\n// V-PHASE3-1730-062 (Created) | V-FINAL-1730-607 (Currency Fix) | V-FINAL-1730-614 (Consolidated)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\nuse Illuminate\\Support\\Facades\\DB;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('payments', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->foreignId('subscription_id')->constrained()->onDelete('cascade');\n            \n            $table->decimal('amount', 10, 2);\n            $table->string('currency', 3)->default('INR');\n            $table->string('status')->default('pending');\n            $table->string('payment_type')->default('sip_installment');\n            \n            $table->string('gateway')->nullable();\n            $table->string('gateway_order_id')->nullable()->index();\n            $table->string('gateway_payment_id')->nullable()->index();\n            $table->text('gateway_signature')->nullable();\n            \n            $table->string('method')->nullable();\n            $table->string('payment_proof_path')->nullable();\n            \n            $table->foreignId('refunds_payment_id')->nullable()->constrained('payments')->onDelete('set null');\n\n            $table->timestamp('paid_at')->nullable();\n            $table->boolean('is_on_time')->default(false);\n            $table->boolean('is_flagged')->default(false);\n            $table->text('flag_reason')->nullable();\n            $table->integer('retry_count')->default(0);\n            $table->text('failure_reason')->nullable();\n            \n            $table->timestamps();\n        });\n        \n        DB::statement('ALTER TABLE payments ADD CONSTRAINT payment_amount_must_be_positive CHECK (amount >= 0)');\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('payments');\n    }\n};"
    },
    {
        "name": "2025_11_11_000302_create_user_investments_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000302_create_user_investments_table.php",
        "content": "<?php\n// V-PHASE3-1730-063\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('user_investments', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->foreignId('product_id')->constrained()->onDelete('restrict');\n            $table->foreignId('payment_id')->constrained()->onDelete('cascade');\n            $table->foreignId('bulk_purchase_id')->constrained()->onDelete('restrict');\n            \n            $table->decimal('units_allocated', 14, 4);\n            $table->decimal('value_allocated', 14, 2); // Face value\n            $table->string('source'); // 'investment' or 'bonus'\n            \n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('user_investments');\n    }\n};"
    },
    {
        "name": "2025_11_11_000303_create_wallets_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000303_create_wallets_table.php",
        "content": "<?php\n// V-PHASE3-1730-064 (Created) | V-FINAL-1730-615 (Consolidated)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\nuse Illuminate\\Support\\Facades\\DB;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('wallets', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->decimal('balance', 14, 2)->default(0);\n            $table->decimal('locked_balance', 14, 2)->default(0);\n            $table->timestamps();\n        });\n        \n// V-PHASE3-1730-065\n        Schema::create('transactions', function (Blueprint $table) {\n            $table->id();\n            $table->uuid('transaction_id')->unique();\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->foreignId('wallet_id')->constrained()->onDelete('cascade');\n            \n            $table->string('type'); // deposit, withdrawal, bonus, etc.\n            $table->string('status')->default('completed'); // pending, completed\n            \n            $table->decimal('amount', 14, 2);\n            $table->decimal('balance_before', 14, 2)->default(0);\n            $table->decimal('balance_after', 14, 2);\n            \n            $table->decimal('tds_deducted', 10, 2)->default(0);\n            $table->text('description');\n            \n            $table->morphs('reference'); // Links to Payment, Withdrawal, Bonus\n            $table->timestamps();\n        });\n\n// V-PHASE3-1730-066\n        Schema::create('withdrawals', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->foreignId('wallet_id')->constrained()->onDelete('cascade');\n            \n            $table->decimal('amount', 10, 2);\n            $table->decimal('fee', 10, 2)->default(0);\n            $table->decimal('tds_deducted', 10, 2)->default(0);\n            $table->decimal('net_amount', 10, 2); // amount - fee - tds\n            \n            $table->string('status')->default('pending');\n            $table->json('bank_details');\n            \n            $table->foreignId('admin_id')->nullable()->constrained('users');\n            $table->string('utr_number')->nullable();\n            $table->text('rejection_reason')->nullable();\n            \n            $table->timestamps();\n        });\n        \n        DB::statement('ALTER TABLE wallets ADD CONSTRAINT balance_must_be_positive CHECK (balance >= 0)');\n        DB::statement('ALTER TABLE wallets ADD CONSTRAINT locked_balance_must_be_positive CHECK (locked_balance >= 0)');\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('withdrawals');\n        Schema::dropIfExists('transactions');\n        Schema::dropIfExists('wallets');\n    }\n};"
    },
    {
        "name": "2025_11_11_000305_create_bonus_and_referral_tables.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000305_create_bonus_and_referral_tables.php",
        "content": "<?php\n// V-PHASE3-1730-067 (Created) | V-FINAL-1730-616 (Consolidated)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\nuse Illuminate\\Support\\Facades\\DB;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('bonus_transactions', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->foreignId('subscription_id')->constrained()->onDelete('cascade');\n            $table->foreignId('payment_id')->nullable()->constrained()->onDelete('set null');\n            \n            $table->string('type');\n            $table->decimal('amount', 10, 2);\n            $table->decimal('tds_deducted', 10, 2)->default(0);\n            \n            $table->decimal('multiplier_applied', 5, 2)->default(1.00);\n            $table->decimal('base_amount', 10, 2)->nullable();\n            $table->text('description');\n            \n            $table->timestamps();\n        });\n\n        Schema::create('referral_campaigns', function (Blueprint $table) {\n            $table->id();\n            $table->string('name');\n            $table->dateTime('start_date');\n            $table->dateTime('end_date');\n            $table->decimal('multiplier', 5, 2)->default(1.0);\n            $table->decimal('bonus_amount', 10, 2)->default(0);\n            $table->boolean('is_active')->default(true);\n            $table->timestamps();\n        });\n        \n// V-PHASE3-1730-068\n        Schema::create('referrals', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('referrer_id')->constrained('users')->onDelete('cascade');\n            $table->foreignId('referred_id')->constrained('users')->onDelete('cascade');\n            $table->foreignId('referral_campaign_id')->nullable()->constrained('referral_campaigns')->onDelete('set null');\n            \n            $table->string('status')->default('pending');\n            $table->timestamp('completed_at')->nullable();\n            $table->timestamps();\n            \n            $table->unique(['referrer_id', 'referred_id']);\n            $table->unique('referred_id');\n        });\n        \n        DB::statement('ALTER TABLE bonus_transactions ADD CONSTRAINT bonus_amount_not_zero CHECK (amount != 0)');\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('referrals');\n        Schema::dropIfExists('referral_campaigns');\n        Schema::dropIfExists('bonus_transactions');\n    }\n};"
    },
    {
        "name": "2025_11_11_000308_create_bonus_modules_tables.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_000308_create_bonus_modules_tables.php",
        "content": "<?php\n// V-PHASE3-1730-069 (Created) | V-FINAL-1730-617 (Consolidated)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        // Lucky Draw\n        Schema::create('lucky_draws', function (Blueprint $table) {\n            $table->id();\n            $table->string('name');\n            $table->date('draw_date');\n            $table->json('prize_structure');\n            $table->string('status')->default('open');\n            $table->timestamps();\n            $table->softDeletes();\n        });\n\n// V-PHASE3-1730-070\n        Schema::create('lucky_draw_entries', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->foreignId('lucky_draw_id')->constrained()->onDelete('cascade');\n            $table->foreignId('payment_id')->constrained()->onDelete('cascade');\n            \n            $table->integer('base_entries')->default(0);\n            $table->integer('bonus_entries')->default(0);\n\n            $table->boolean('is_winner')->default(false);\n            $table->integer('prize_rank')->nullable();\n            $table->decimal('prize_amount', 10, 2)->nullable();\n            \n            $table->timestamps();\n            $table->unique(['user_id', 'lucky_draw_id']);\n        });\n\n// V-PHASE3-1730-071\n        // Profit Sharing\n        Schema::create('profit_shares', function (Blueprint $table) {\n            $table->id();\n            $table->string('period_name')->unique();\n            $table->date('start_date');\n            $table->date('end_date');\n            $table->decimal('total_pool', 14, 2);\n            $table->decimal('net_profit', 14, 2);\n            $table->string('status')->default('pending');\n            $table->foreignId('admin_id')->nullable()->constrained('users');\n            $table->timestamps();\n        });\n\n// V-PHASE3-1730-072\n        Schema::create('user_profit_shares', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->foreignId('profit_share_id')->constrained('profit_shares')->onDelete('cascade');\n            $table->decimal('amount', 10, 2);\n            $table->foreignId('bonus_transaction_id')->nullable()->constrained('bonus_transactions');\n            $table->text('notes')->nullable();\n            $table->timestamps();\n        });\n        \n        // Celebration Bonuses\n        Schema::create('celebration_events', function (Blueprint $table) {\n            $table->id();\n            $table->string('name');\n            $table->date('event_date');\n            $table->json('bonus_amount_by_plan');\n            $table->boolean('is_active')->default(true);\n            $table->boolean('is_recurring_annually')->default(true);\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('celebration_events');\n        Schema::dropIfExists('user_profit_shares');\n        Schema::dropIfExists('profit_shares');\n        Schema::dropIfExists('lucky_draw_entries');\n        Schema::dropIfExists('lucky_draws');\n    }\n};"
    },
    {
        "name": "2025_11_11_173232_create_personal_access_tokens_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_173232_create_personal_access_tokens_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     */\n    public function up(): void\n    {\n        Schema::create('personal_access_tokens', function (Blueprint $table) {\n            $table->id();\n            $table->morphs('tokenable');\n            $table->text('name');\n            $table->string('token', 64)->unique();\n            $table->text('abilities')->nullable();\n            $table->timestamp('last_used_at')->nullable();\n            $table->timestamp('expires_at')->nullable()->index();\n            $table->timestamps();\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void\n    {\n        Schema::dropIfExists('personal_access_tokens');\n    }\n};\n"
    },
    {
        "name": "2025_11_11_173256_create_permission_tables.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_11_173256_create_permission_tables.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     */\n    public function up(): void\n    {\n        $teams = config('permission.teams');\n        $tableNames = config('permission.table_names');\n        $columnNames = config('permission.column_names');\n        $pivotRole = $columnNames['role_pivot_key'] ?? 'role_id';\n        $pivotPermission = $columnNames['permission_pivot_key'] ?? 'permission_id';\n\n        throw_if(empty($tableNames), Exception::class, 'Error: config/permission.php not loaded. Run [php artisan config:clear] and try again.');\n        throw_if($teams && empty($columnNames['team_foreign_key'] ?? null), Exception::class, 'Error: team_foreign_key on config/permission.php not loaded. Run [php artisan config:clear] and try again.');\n\n        Schema::create($tableNames['permissions'], static function (Blueprint $table) {\n            // $table->engine('InnoDB');\n            $table->bigIncrements('id'); // permission id\n            $table->string('name');       // For MyISAM use string('name', 225); // (or 166 for InnoDB with Redundant/Compact row format)\n            $table->string('guard_name'); // For MyISAM use string('guard_name', 25);\n            $table->timestamps();\n\n            $table->unique(['name', 'guard_name']);\n        });\n\n        Schema::create($tableNames['roles'], static function (Blueprint $table) use ($teams, $columnNames) {\n            // $table->engine('InnoDB');\n            $table->bigIncrements('id'); // role id\n            if ($teams || config('permission.testing')) { // permission.testing is a fix for sqlite testing\n                $table->unsignedBigInteger($columnNames['team_foreign_key'])->nullable();\n                $table->index($columnNames['team_foreign_key'], 'roles_team_foreign_key_index');\n            }\n            $table->string('name');       // For MyISAM use string('name', 225); // (or 166 for InnoDB with Redundant/Compact row format)\n            $table->string('guard_name'); // For MyISAM use string('guard_name', 25);\n            $table->timestamps();\n            if ($teams || config('permission.testing')) {\n                $table->unique([$columnNames['team_foreign_key'], 'name', 'guard_name']);\n            } else {\n                $table->unique(['name', 'guard_name']);\n            }\n        });\n\n        Schema::create($tableNames['model_has_permissions'], static function (Blueprint $table) use ($tableNames, $columnNames, $pivotPermission, $teams) {\n            $table->unsignedBigInteger($pivotPermission);\n\n            $table->string('model_type');\n            $table->unsignedBigInteger($columnNames['model_morph_key']);\n            $table->index([$columnNames['model_morph_key'], 'model_type'], 'model_has_permissions_model_id_model_type_index');\n\n            $table->foreign($pivotPermission)\n                ->references('id') // permission id\n                ->on($tableNames['permissions'])\n                ->onDelete('cascade');\n            if ($teams) {\n                $table->unsignedBigInteger($columnNames['team_foreign_key']);\n                $table->index($columnNames['team_foreign_key'], 'model_has_permissions_team_foreign_key_index');\n\n                $table->primary([$columnNames['team_foreign_key'], $pivotPermission, $columnNames['model_morph_key'], 'model_type'],\n                    'model_has_permissions_permission_model_type_primary');\n            } else {\n                $table->primary([$pivotPermission, $columnNames['model_morph_key'], 'model_type'],\n                    'model_has_permissions_permission_model_type_primary');\n            }\n\n        });\n\n        Schema::create($tableNames['model_has_roles'], static function (Blueprint $table) use ($tableNames, $columnNames, $pivotRole, $teams) {\n            $table->unsignedBigInteger($pivotRole);\n\n            $table->string('model_type');\n            $table->unsignedBigInteger($columnNames['model_morph_key']);\n            $table->index([$columnNames['model_morph_key'], 'model_type'], 'model_has_roles_model_id_model_type_index');\n\n            $table->foreign($pivotRole)\n                ->references('id') // role id\n                ->on($tableNames['roles'])\n                ->onDelete('cascade');\n            if ($teams) {\n                $table->unsignedBigInteger($columnNames['team_foreign_key']);\n                $table->index($columnNames['team_foreign_key'], 'model_has_roles_team_foreign_key_index');\n\n                $table->primary([$columnNames['team_foreign_key'], $pivotRole, $columnNames['model_morph_key'], 'model_type'],\n                    'model_has_roles_role_model_type_primary');\n            } else {\n                $table->primary([$pivotRole, $columnNames['model_morph_key'], 'model_type'],\n                    'model_has_roles_role_model_type_primary');\n            }\n        });\n\n        Schema::create($tableNames['role_has_permissions'], static function (Blueprint $table) use ($tableNames, $pivotRole, $pivotPermission) {\n            $table->unsignedBigInteger($pivotPermission);\n            $table->unsignedBigInteger($pivotRole);\n\n            $table->foreign($pivotPermission)\n                ->references('id') // permission id\n                ->on($tableNames['permissions'])\n                ->onDelete('cascade');\n\n            $table->foreign($pivotRole)\n                ->references('id') // role id\n                ->on($tableNames['roles'])\n                ->onDelete('cascade');\n\n            $table->primary([$pivotPermission, $pivotRole], 'role_has_permissions_permission_id_role_id_primary');\n        });\n\n        app('cache')\n            ->store(config('permission.cache.store') != 'default' ? config('permission.cache.store') : null)\n            ->forget(config('permission.cache.key'));\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void\n    {\n        $tableNames = config('permission.table_names');\n\n        throw_if(empty($tableNames), Exception::class, 'Error: config/permission.php not found and defaults could not be merged. Please publish the package configuration before proceeding, or drop the tables manually.');\n\n        Schema::drop($tableNames['role_has_permissions']);\n        Schema::drop($tableNames['model_has_roles']);\n        Schema::drop($tableNames['model_has_permissions']);\n        Schema::drop($tableNames['roles']);\n        Schema::drop($tableNames['permissions']);\n    }\n};\n"
    },
    {
        "name": "2025_11_12_000401_create_support_tickets_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_12_000401_create_support_tickets_table.php",
        "content": "<?php\n// Split from: 2025_11_12_000400_create_cms_and_support_tables.php\n// Table: support_tickets\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('support_tickets', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->string('ticket_code')->unique();\n            $table->string('subject');\n            $table->string('category');\n            $table->string('priority')->default('medium');\n            $table->string('status')->default('open');\n            $table->integer('sla_hours')->default(24);\n            $table->foreignId('assigned_to')->nullable()->constrained('users')->onDelete('set null');\n            $table->foreignId('resolved_by')->nullable()->constrained('users')->onDelete('set null');\n            $table->timestamp('resolved_at')->nullable();\n            $table->timestamp('closed_at')->nullable();\n            $table->unsignedTinyInteger('rating')->nullable();\n            $table->text('rating_feedback')->nullable();\n            $table->timestamps();\n            $table->softDeletes();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('support_tickets');\n    }\n};\n"
    },
    {
        "name": "2025_11_12_000402_create_support_messages_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_12_000402_create_support_messages_table.php",
        "content": "<?php\n// Split from: 2025_11_12_000400_create_cms_and_support_tables.php\n// Table: support_messages\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('support_messages', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('support_ticket_id')->constrained()->onDelete('cascade');\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->boolean('is_admin_reply')->default(false);\n            $table->text('message');\n            $table->json('attachments')->nullable();\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('support_messages');\n    }\n};\n"
    },
    {
        "name": "2025_11_12_000404_create_pages_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_12_000404_create_pages_table.php",
        "content": "<?php\n// Split from: 2025_11_12_000400_create_cms_and_support_tables.php\n// Table: pages (CMS)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('pages', function (Blueprint $table) {\n            $table->id();\n            $table->string('title');\n            $table->string('slug')->unique();\n            $table->longText('content')->nullable();\n            $table->json('seo_meta')->nullable();\n            $table->string('status')->default('draft');\n            $table->integer('current_version')->default(1);\n            $table->boolean('require_user_acceptance')->default(false);\n            $table->timestamps();\n            $table->softDeletes();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('pages');\n    }\n};\n"
    },
    {
        "name": "2025_11_12_000405_create_page_versions_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_12_000405_create_page_versions_table.php",
        "content": "<?php\n// Split from: 2025_11_12_000400_create_cms_and_support_tables.php\n// Table: page_versions\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('page_versions', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('page_id')->constrained()->onDelete('cascade');\n            $table->foreignId('author_id')->nullable()->constrained('users')->onDelete('set null');\n            $table->integer('version')->default(1);\n            $table->string('title');\n            $table->longText('content');\n            $table->string('change_summary')->nullable();\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('page_versions');\n    }\n};\n"
    },
    {
        "name": "2025_11_12_000406_create_user_legal_acceptances_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_12_000406_create_user_legal_acceptances_table.php",
        "content": "<?php\n// Split from: 2025_11_12_000400_create_cms_and_support_tables.php\n// Table: user_legal_acceptances\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('user_legal_acceptances', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->foreignId('page_id')->constrained()->onDelete('cascade');\n            $table->integer('page_version');\n            $table->string('ip_address');\n            $table->timestamps();\n            $table->unique(['user_id', 'page_id', 'page_version']);\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('user_legal_acceptances');\n    }\n};\n"
    },
    {
        "name": "2025_11_12_000407_create_banners_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_12_000407_create_banners_table.php",
        "content": "<?php\n// Split from: 2025_11_12_000400_create_cms_and_support_tables.php\n// Table: banners (CMS Marketing)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('banners', function (Blueprint $table) {\n            $table->id();\n            $table->unsignedInteger('variant_of')->nullable();\n            $table->string('title');\n            $table->text('content')->nullable();\n            $table->string('link_url')->nullable();\n            $table->string('type')->default('top_bar');\n            $table->string('trigger_type')->default('load');\n            $table->integer('trigger_value')->default(0);\n            $table->string('frequency')->default('always');\n            $table->json('targeting_rules')->nullable();\n            $table->json('style_config')->nullable();\n            $table->integer('display_weight')->default(1);\n            $table->dateTime('start_at')->nullable();\n            $table->dateTime('end_at')->nullable();\n            $table->boolean('is_active')->default(true);\n            $table->integer('display_order')->default(0);\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('banners');\n    }\n};\n"
    },
    {
        "name": "2025_11_12_000408_create_redirects_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_12_000408_create_redirects_table.php",
        "content": "<?php\n// Split from: 2025_11_12_000400_create_cms_and_support_tables.php\n// Table: redirects (CMS)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('redirects', function (Blueprint $table) {\n            $table->id();\n            $table->string('from_url')->unique();\n            $table->string('to_url');\n            $table->integer('status_code')->default(301);\n            $table->unsignedBigInteger('hit_count')->default(0);\n            $table->boolean('is_active')->default(true);\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('redirects');\n    }\n};\n"
    },
    {
        "name": "2025_11_12_000409_create_kb_categories_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_12_000409_create_kb_categories_table.php",
        "content": "<?php\n// Split from: 2025_11_12_000400_create_cms_and_support_tables.php\n// Table: kb_categories (Knowledge Base)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('kb_categories', function (Blueprint $table) {\n            $table->id();\n            $table->string('name');\n            $table->string('slug')->unique();\n            $table->string('icon')->nullable();\n            $table->text('description')->nullable();\n            $table->foreignId('parent_id')->nullable()->constrained('kb_categories')->onDelete('set null');\n            $table->integer('display_order')->default(0);\n            $table->boolean('is_active')->default(true);\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('kb_categories');\n    }\n};\n"
    },
    {
        "name": "2025_11_12_000410_create_kb_articles_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_12_000410_create_kb_articles_table.php",
        "content": "<?php\n// Split from: 2025_11_12_000400_create_cms_and_support_tables.php\n// Table: kb_articles (Knowledge Base)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('kb_articles', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('kb_category_id')->constrained()->onDelete('cascade');\n            $table->foreignId('author_id')->constrained('users')->onDelete('restrict');\n            $table->string('title');\n            $table->string('slug')->unique();\n            $table->text('content');\n            $table->string('featured_image')->nullable();\n            $table->string('status')->default('draft');\n            $table->timestamp('published_at')->nullable();\n            $table->json('seo_meta')->nullable();\n            $table->integer('views')->default(0);\n            $table->integer('helpful_yes')->default(0);\n            $table->integer('helpful_no')->default(0);\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('kb_articles');\n    }\n};\n"
    },
    {
        "name": "2025_11_14_000100_create_notifications_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_14_000100_create_notifications_table.php",
        "content": "<?php\n// V-FINAL-1730-233\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('notifications', function (Blueprint $table) {\n            $table->uuid('id')->primary();\n            $table->string('type');\n            $table->morphs('notifiable');\n            $table->text('data');\n            $table->timestamp('read_at')->nullable();\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('notifications');\n    }\n};"
    },
    {
        "name": "2025_11_14_001000_create_blog_and_faq_tables.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_14_001000_create_blog_and_faq_tables.php",
        "content": "<?php\n// V-FINAL-1730-285\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('blog_posts', function (Blueprint $table) {\n            $table->id();\n            $table->string('title');\n            $table->string('slug')->unique();\n            $table->text('content');\n            $table->string('featured_image')->nullable();\n            $table->foreignId('author_id')->constrained('users');\n            $table->string('status')->default('draft'); // draft, published\n            $table->timestamps();\n            $table->softDeletes();\n        });\n\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('blog_posts');\n    }\n};"
    },
    {
        "name": "2025_11_14_001600_add_check_constraint_to_wallets.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_14_001600_add_check_constraint_to_wallets.php",
        "content": "<?php\n// V-FINAL-1730-352 (FIXED)\n\nuse Illuminate\\Database\\Migrations\\Migration; // <-- CORRECTED\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\nuse Illuminate\\Support\\Facades\\DB;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     * This adds a database-level rule to prevent negative balances.\n     */\n    public function up(): void\n    {\n        // Add a CHECK constraint\n        // Note: CHECK constraints are supported by MySQL 8.0.16+ and PostgreSQL\n        try {\n            DB::statement('ALTER TABLE wallets ADD CONSTRAINT balance_must_be_positive CHECK (balance >= 0)');\n            DB::statement('ALTER TABLE wallets ADD CONSTRAINT locked_balance_must_be_positive CHECK (locked_balance >= 0)');\n        } catch (\\Exception $e) {\n            // Failsafe for older MySQL or SQLite versions\n            logger('Could not add CHECK constraints to wallets table: ' . $e->getMessage());\n        }\n    }\n\n    public function down(): void\n    {\n        // We must check if constraint exists before dropping (more robust)\n        if (DB::getDriverName() !== 'sqlite') {\n            Schema::table('wallets', function (Blueprint $table) {\n                try {\n                    $table->dropConstrainedForeignId('balance_must_be_positive');\n                    $table->dropConstrainedForeignId('locked_balance_must_be_positive');\n                } catch (\\Exception $e) {\n                    logger('Could not drop wallet constraints: ' . $e->getMessage());\n                }\n            });\n        }\n    }\n};"
    },
    {
        "name": "2025_11_14_002200_create_email_infrastructure_tables.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_14_002200_create_email_infrastructure_tables.php",
        "content": "<?php\n// V-FINAL-1730-386 (Created)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        // FSD-NOTIF-006: Logs all sent emails\n        Schema::create('email_logs', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->nullable()->constrained()->onDelete('set null');\n            $table->string('template_slug');\n            $table->string('to_email');\n            $table->string('subject');\n            $table->longText('body');\n            $table->string('status')->default('queued'); // queued, sending, sent, failed\n            $table->text('error_message')->nullable();\n            $table->timestamps();\n        });\n\n        // FSD-NOTIF-016: Stores user opt-out preferences\n        Schema::create('user_notification_preferences', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->constrained()->onDelete('cascade');\n            $table->string('preference_key'); // e.g., \"bonus_email\", \"marketing_email\"\n            $table->boolean('is_enabled')->default(true);\n            $table->timestamps();\n            \n            $table->unique(['user_id', 'preference_key']);\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('email_logs');\n        Schema::dropIfExists('user_notification_preferences');\n    }\n};"
    },
    {
        "name": "2025_11_14_002300_create_sms_logs_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_14_002300_create_sms_logs_table.php",
        "content": "<?php\n// V-FINAL-1730-390 (Created)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * FSD-NOTIF-011: SMS Logs\n     */\n    public function up(): void\n    {\n        Schema::create('sms_logs', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('user_id')->nullable()->constrained()->onDelete('set null');\n            $table->string('to_mobile');\n            $table->string('template_slug')->nullable();\n            $table->string('dlt_template_id')->nullable();\n            $table->text('message');\n            $table->string('status')->default('queued'); // queued, sending, sent, failed\n            $table->text('error_message')->nullable();\n            $table->string('gateway_message_id')->nullable();\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('sms_logs');\n    }\n};"
    },
    {
        "name": "2025_11_15_004000_create_kyc_rejection_templates_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_15_004000_create_kyc_rejection_templates_table.php",
        "content": "<?php\n// V-FINAL-1730-472 (Created)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     * FSD-KYC-019: Predefined rejection reasons.\n     */\n    public function up(): void\n    {\n        Schema::create('kyc_rejection_templates', function (Blueprint $table) {\n            $table->id();\n            $table->string('title')->nullable(); // e.g., \"Blurry PAN Card\"\n            $table->string('name'); // <-- REQUIRED\n            $table->text('reason');  // e.g., \"The image of your PAN card was blurry...\"\n            $table->string('category');       // e.g. \"document_quality\", \"identity_mismatch\"\n            $table->text('message')->nullable(); // <-- Required: rejection message\n            $table->boolean('is_active')->default(true);\n            $table->timestamps();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('kyc_rejection_templates');\n    }\n};"
    },
    {
        "name": "2025_11_15_016000_add_tds_to_transactions.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_15_016000_add_tds_to_transactions.php",
        "content": "<?php\n// V-FINAL-1730-565 (Created) | V-FINAL-1730-569 (Defensive Fix)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     * FSD-REPORT-017: Add TDS fields\n     */\n    public function up(): void\n    {\n        Schema::table('bonus_transactions', function (Blueprint $table) {\n            // --- FIX: Check before adding ---\n            if (!Schema::hasColumn('bonus_transactions', 'tds_deducted')) {\n                $table->decimal('tds_deducted', 10, 2)->default(0)->after('amount');\n            }\n        });\n\n        Schema::table('withdrawals', function (Blueprint $table) {\n            // --- FIX: Check before adding ---\n            if (!Schema::hasColumn('withdrawals', 'tds_deducted')) {\n                $table->decimal('tds_deducted', 10, 2)->default(0)->after('fee');\n            }\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void\n    {\n        Schema::table('bonus_transactions', function (Blueprint $table) {\n            if (Schema::hasColumn('bonus_transactions', 'tds_deducted')) {\n                $table->dropColumn('tds_deducted');\n            }\n        });\n        \n        Schema::table('withdrawals', function (Blueprint $table) {\n            if (Schema::hasColumn('withdrawals', 'tds_deducted')) {\n                $table->dropColumn('tds_deducted');\n            }\n        });\n    }\n};"
    },
    {
        "name": "2025_11_16_000000_create_missing_modules_tables.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_16_000000_create_missing_modules_tables.php",
        "content": "<?php\n// V-FINAL-1730-648 (Created)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     * Creates tables for modules that were referenced but not yet backed by DB tables.\n     */\n    public function up(): void\n    {\n        // 1. Email Templates (FSD-NOTIF-002)\n        if (!Schema::hasTable('email_templates')) {\n            Schema::create('email_templates', function (Blueprint $table) {\n                $table->id();\n                $table->string('name'); // e.g. \"Welcome Email\"\n                $table->string('slug')->unique(); // e.g. \"user.welcome\"\n                $table->string('subject');\n                $table->longText('body'); // HTML content\n                $table->text('variables_available')->nullable(); // JSON or CSV of available vars\n                $table->boolean('is_active')->default(true);\n                $table->timestamps();\n            });\n        }\n\n        // 2. SMS Templates (FSD-NOTIF-008)\n        if (!Schema::hasTable('sms_templates')) {\n            Schema::create('sms_templates', function (Blueprint $table) {\n                $table->id();\n                $table->string('name');\n                $table->string('slug')->unique();\n                $table->text('body'); // Max 160 chars ideally\n                $table->string('dlt_template_id')->nullable(); // Compliance\n                $table->boolean('is_active')->default(true);\n                $table->timestamps();\n            });\n        }\n\n        // 3. Blog Posts (FSD-FRONT-008)\n        if (!Schema::hasTable('blog_posts')) {\n            Schema::create('blog_posts', function (Blueprint $table) {\n                $table->id();\n                $table->string('title');\n                $table->string('slug')->unique();\n                $table->longText('content');\n                $table->string('excerpt')->nullable();\n                $table->string('featured_image')->nullable();\n                $table->string('status')->default('draft'); // draft, published\n                $table->foreignId('author_id')->constrained('users');\n                $table->timestamp('published_at')->nullable();\n                $table->json('seo_meta')->nullable();\n                $table->timestamps();\n            });\n        }\n\n        // 4. FAQs (FSD-FRONT-007)\n        if (!Schema::hasTable('faqs')) {\n            Schema::create('faqs', function (Blueprint $table) {\n                $table->id();\n                $table->string('question');\n                $table->text('answer');\n                $table->string('category')->default('general');\n                $table->integer('display_order')->default(0);\n                $table->boolean('is_published')->default(true);\n                $table->timestamps();\n            });\n        }\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void\n    {\n        Schema::dropIfExists('faqs');\n        Schema::dropIfExists('blog_posts');\n        Schema::dropIfExists('sms_templates');\n        Schema::dropIfExists('email_templates');\n    }\n};"
    },
    {
        "name": "2025_11_16_001000_create_missing_system_tables.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_16_001000_create_missing_system_tables.php",
        "content": "<?php\n// V-FINAL-1730-653 (Restoring Missing Tables)\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        // 1. Activity Logs (Required for Admin Dashboard)\n        if (!Schema::hasTable('activity_logs')) {\n            Schema::create('activity_logs', function (Blueprint $table) {\n                $table->id();\n                $table->foreignId('user_id')->nullable()->constrained()->onDelete('set null');\n                $table->string('action');\n                $table->text('description')->nullable();\n                $table->string('ip_address')->nullable();\n                $table->string('user_agent')->nullable();\n                \n                // Audit fields\n                $table->nullableMorphs('target'); // target_type, target_id\n                $table->json('old_values')->nullable();\n                $table->json('new_values')->nullable();\n                \n                $table->timestamp('created_at')->nullable();\n            });\n        }\n\n        // 2. Notifications (Required for User Dashboard)\n        if (!Schema::hasTable('notifications')) {\n            Schema::create('notifications', function (Blueprint $table) {\n                $table->uuid('id')->primary();\n                $table->string('type');\n                $table->morphs('notifiable');\n                $table->text('data');\n                $table->timestamp('read_at')->nullable();\n                $table->timestamps();\n            });\n        }\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('notifications');\n        Schema::dropIfExists('activity_logs');\n    }\n};"
    },
    {
        "name": "2025_11_19_000000_create_ip_whitelist_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_19_000000_create_ip_whitelist_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     * Creates the 'ip_whitelist' table based on the fields required by the\n     * IpWhitelistController (ip_address, description, is_active).\n     */\n    public function up(): void\n    {\n        Schema::create('ip_whitelist', function (Blueprint $table) {\n            // Primary Key\n            $table->id();\n\n            // Data Fields\n            // The IpWhitelistController uses a 'unique' rule on this column.\n            $table->string('ip_address')->unique()->comment('The whitelisted IP address.');\n\n            // Metadata\n            $table->string('description', 255)->comment('A short description for why this IP is whitelisted.');\n            \n            // Status Field\n            // The application logic relies on this field (WHERE is_active = 1).\n            $table->boolean('is_active')->default(true)->index()->comment('Status for quick lookups and querying.');\n\n            // Timestamps\n            $table->timestamps();\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void\n    {\n        Schema::dropIfExists('ip_whitelist');\n    }\n};"
    },
    {
        "name": "2025_11_23_000000_add_performance_indexes.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_23_000000_add_performance_indexes.php",
        "content": "<?php\n// V-PERFORMANCE-INDEXES - Add missing database indexes for performance optimization\n// V-FIX: Added column existence checks to prevent migration failures\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     */\n    public function up(): void\n    {\n        // Users table indexes\n        if (Schema::hasTable('users')) {\n            Schema::table('users', function (Blueprint $table) {\n                // Only create composite index if both columns exist\n                if ($this->hasColumn('users', 'status') && $this->hasColumn('users', 'kyc_status')) {\n                    if (!$this->hasIndex('users', 'users_status_kyc_status_index')) {\n                        $table->index(['status', 'kyc_status'], 'users_status_kyc_status_index');\n                    }\n                }\n                if ($this->hasColumn('users', 'referral_code') && !$this->hasIndex('users', 'users_referral_code_index')) {\n                    $table->index('referral_code', 'users_referral_code_index');\n                }\n                if ($this->hasColumn('users', 'referred_by') && !$this->hasIndex('users', 'users_referred_by_index')) {\n                    $table->index('referred_by', 'users_referred_by_index');\n                }\n                if ($this->hasColumn('users', 'status') && !$this->hasIndex('users', 'users_status_index')) {\n                    $table->index('status', 'users_status_index');\n                }\n            });\n        }\n\n        // Payments table indexes\n        if (Schema::hasTable('payments')) {\n            Schema::table('payments', function (Blueprint $table) {\n                if ($this->hasColumn('payments', 'user_id') && $this->hasColumn('payments', 'status')) {\n                    if (!$this->hasIndex('payments', 'payments_user_status_index')) {\n                        $table->index(['user_id', 'status'], 'payments_user_status_index');\n                    }\n                }\n                if ($this->hasColumn('payments', 'status') && $this->hasColumn('payments', 'created_at')) {\n                    if (!$this->hasIndex('payments', 'payments_status_created_index')) {\n                        $table->index(['status', 'created_at'], 'payments_status_created_index');\n                    }\n                }\n                if ($this->hasColumn('payments', 'gateway_payment_id') && !$this->hasIndex('payments', 'payments_gateway_payment_index')) {\n                    $table->index('gateway_payment_id', 'payments_gateway_payment_index');\n                }\n            });\n        }\n\n        // Subscriptions table indexes\n        if (Schema::hasTable('subscriptions')) {\n            Schema::table('subscriptions', function (Blueprint $table) {\n                if ($this->hasColumn('subscriptions', 'user_id') && $this->hasColumn('subscriptions', 'status')) {\n                    if (!$this->hasIndex('subscriptions', 'subscriptions_user_status_index')) {\n                        $table->index(['user_id', 'status'], 'subscriptions_user_status_index');\n                    }\n                }\n                if ($this->hasColumn('subscriptions', 'next_payment_date') && !$this->hasIndex('subscriptions', 'subscriptions_next_payment_index')) {\n                    $table->index('next_payment_date', 'subscriptions_next_payment_index');\n                }\n            });\n        }\n\n        // User investments table indexes\n        if (Schema::hasTable('user_investments')) {\n            Schema::table('user_investments', function (Blueprint $table) {\n                if ($this->hasColumn('user_investments', 'user_id') && $this->hasColumn('user_investments', 'product_id')) {\n                    if (!$this->hasIndex('user_investments', 'investments_user_product_index')) {\n                        $table->index(['user_id', 'product_id'], 'investments_user_product_index');\n                    }\n                }\n                if ($this->hasColumn('user_investments', 'status') && !$this->hasIndex('user_investments', 'investments_status_index')) {\n                    $table->index('status', 'investments_status_index');\n                }\n            });\n        }\n\n        // Wallets table indexes\n        if (Schema::hasTable('wallets')) {\n            Schema::table('wallets', function (Blueprint $table) {\n                if ($this->hasColumn('wallets', 'user_id')) {\n                    if (!$this->hasIndex('wallets', 'wallets_user_index')) {\n                        $table->index('user_id', 'wallets_user_index');\n                    }\n                }\n            });\n        }\n\n        // Withdrawals table indexes\n        if (Schema::hasTable('withdrawals')) {\n            Schema::table('withdrawals', function (Blueprint $table) {\n                if ($this->hasColumn('withdrawals', 'user_id') && $this->hasColumn('withdrawals', 'status')) {\n                    if (!$this->hasIndex('withdrawals', 'withdrawals_user_status_index')) {\n                        $table->index(['user_id', 'status'], 'withdrawals_user_status_index');\n                    }\n                }\n                if ($this->hasColumn('withdrawals', 'status') && $this->hasColumn('withdrawals', 'created_at')) {\n                    if (!$this->hasIndex('withdrawals', 'withdrawals_status_created_index')) {\n                        $table->index(['status', 'created_at'], 'withdrawals_status_created_index');\n                    }\n                }\n            });\n        }\n\n        // KYC documents table indexes\n        if (Schema::hasTable('kyc_documents')) {\n            Schema::table('kyc_documents', function (Blueprint $table) {\n                if ($this->hasColumn('kyc_documents', 'user_id') && $this->hasColumn('kyc_documents', 'status')) {\n                    if (!$this->hasIndex('kyc_documents', 'kyc_user_status_index')) {\n                        $table->index(['user_id', 'status'], 'kyc_user_status_index');\n                    }\n                }\n            });\n        }\n\n        // Activity logs table indexes\n        if (Schema::hasTable('activity_logs')) {\n            Schema::table('activity_logs', function (Blueprint $table) {\n                if ($this->hasColumn('activity_logs', 'user_id') && $this->hasColumn('activity_logs', 'created_at')) {\n                    if (!$this->hasIndex('activity_logs', 'activity_user_created_index')) {\n                        $table->index(['user_id', 'created_at'], 'activity_user_created_index');\n                    }\n                }\n            });\n        }\n\n        // Notifications table indexes\n        if (Schema::hasTable('notifications')) {\n            Schema::table('notifications', function (Blueprint $table) {\n                if ($this->hasColumn('notifications', 'user_id') && $this->hasColumn('notifications', 'is_read')) {\n                    if (!$this->hasIndex('notifications', 'notifications_user_read_index')) {\n                        $table->index(['user_id', 'is_read'], 'notifications_user_read_index');\n                    }\n                }\n            });\n        }\n\n        // Bonus transactions table indexes\n        if (Schema::hasTable('bonus_transactions')) {\n            Schema::table('bonus_transactions', function (Blueprint $table) {\n                if ($this->hasColumn('bonus_transactions', 'user_id') && $this->hasColumn('bonus_transactions', 'type')) {\n                    if (!$this->hasIndex('bonus_transactions', 'bonus_tx_user_type_index')) {\n                        $table->index(['user_id', 'type'], 'bonus_tx_user_type_index');\n                    }\n                }\n            });\n        }\n\n        // Products table indexes\n        if (Schema::hasTable('products')) {\n            Schema::table('products', function (Blueprint $table) {\n                if ($this->hasColumn('products', 'status') && !$this->hasIndex('products', 'products_status_index')) {\n                    $table->index('status', 'products_status_index');\n                }\n            });\n        }\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void\n    {\n        $this->dropIndexSafely('users', 'users_status_kyc_status_index');\n        $this->dropIndexSafely('users', 'users_referral_code_index');\n        $this->dropIndexSafely('users', 'users_referred_by_index');\n        $this->dropIndexSafely('users', 'users_status_index');\n\n        $this->dropIndexSafely('payments', 'payments_user_status_index');\n        $this->dropIndexSafely('payments', 'payments_status_created_index');\n        $this->dropIndexSafely('payments', 'payments_gateway_payment_index');\n\n        $this->dropIndexSafely('subscriptions', 'subscriptions_user_status_index');\n        $this->dropIndexSafely('subscriptions', 'subscriptions_next_payment_index');\n\n        $this->dropIndexSafely('user_investments', 'investments_user_product_index');\n        $this->dropIndexSafely('user_investments', 'investments_status_index');\n\n        $this->dropIndexSafely('wallets', 'wallets_user_index');\n\n        $this->dropIndexSafely('withdrawals', 'withdrawals_user_status_index');\n        $this->dropIndexSafely('withdrawals', 'withdrawals_status_created_index');\n\n        $this->dropIndexSafely('kyc_documents', 'kyc_user_status_index');\n\n        $this->dropIndexSafely('activity_logs', 'activity_user_created_index');\n\n        $this->dropIndexSafely('notifications', 'notifications_user_read_index');\n\n        $this->dropIndexSafely('bonus_transactions', 'bonus_tx_user_type_index');\n\n        $this->dropIndexSafely('products', 'products_status_index');\n    }\n\n    /**\n     * Check if an index exists on a table\n     */\n    private function hasIndex(string $table, string $indexName): bool\n    {\n        try {\n            $indexes = Schema::getIndexes($table);\n            foreach ($indexes as $index) {\n                if ($index['name'] === $indexName) {\n                    return true;\n                }\n            }\n        } catch (\\Exception $e) {\n            // Table might not exist or other error\n        }\n        return false;\n    }\n\n    /**\n     * Check if a column exists on a table\n     */\n    private function hasColumn(string $table, string $column): bool\n    {\n        return Schema::hasColumn($table, $column);\n    }\n\n    /**\n     * Safely drop an index if it exists\n     */\n    private function dropIndexSafely(string $table, string $indexName): void\n    {\n        if (Schema::hasTable($table) && $this->hasIndex($table, $indexName)) {\n            Schema::table($table, function (Blueprint $table) use ($indexName) {\n                $table->dropIndex($indexName);\n            });\n        }\n    }\n};\n"
    },
    {
        "name": "2025_11_24_093145_create_canned_responses_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_24_093145_create_canned_responses_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     */\n    public function up(): void\n    {\n        Schema::create('canned_responses', function (Blueprint $table) {\n            $table->id();\n            $table->string('title');             // e.g., \"Payment Not Reflected\"\n            $table->longText('content');         // <-- REQUIRED: seeder inserts this\n            $table->string('category');          // e.g., \"payment\", \"kyc\", etc.\n            $table->boolean('is_active')->default(true);\n            $table->timestamps();\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void\n    {\n        Schema::dropIfExists('canned_responses');\n    }\n};\n"
    },
    {
        "name": "2025_11_26_000001_create_legal_agreements_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_26_000001_create_legal_agreements_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('legal_agreements', function (Blueprint $table) {\n            $table->id();\n            $table->string('type'); // terms_of_service, privacy_policy, cookie_policy, investment_disclaimer, refund_policy, etc.\n            $table->string('title');\n            $table->text('description')->nullable();\n            $table->longText('content');\n            $table->string('version'); // e.g., 1.0.0, 2.1.0\n            $table->enum('status', ['draft', 'review', 'active', 'archived', 'superseded'])->default('draft');\n            $table->date('effective_date')->nullable();\n            $table->date('expiry_date')->nullable();\n            $table->boolean('require_signature')->default(false);\n            $table->boolean('is_template')->default(false);\n            $table->foreignId('created_by')->nullable()->constrained('users')->nullOnDelete();\n            $table->foreignId('updated_by')->nullable()->constrained('users')->nullOnDelete();\n            $table->timestamps();\n            $table->softDeletes();\n\n            // Indexes\n            $table->index('type');\n            $table->index('status');\n            $table->index(['type', 'status']);\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('legal_agreements');\n    }\n};\n"
    },
    {
        "name": "2025_11_26_000001_create_webhook_logs_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_26_000001_create_webhook_logs_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     */\n    public function up(): void\n    {\n        Schema::create('webhook_logs', function (Blueprint $table) {\n            $table->id();\n            $table->string('event_type');\n            $table->string('webhook_id')->nullable()->index();\n            $table->text('payload');\n            $table->text('headers')->nullable();\n            $table->enum('status', ['pending', 'processing', 'success', 'failed', 'max_retries_reached'])->default('pending')->index();\n            $table->integer('retry_count')->default(0);\n            $table->integer('max_retries')->default(5);\n            $table->text('response')->nullable();\n            $table->integer('response_code')->nullable();\n            $table->text('error_message')->nullable();\n            $table->timestamp('next_retry_at')->nullable()->index();\n            $table->timestamp('processed_at')->nullable();\n            $table->timestamps();\n\n            // Indexes for performance\n            $table->index(['status', 'next_retry_at']);\n            $table->index(['created_at', 'status']);\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void\n    {\n        Schema::dropIfExists('webhook_logs');\n    }\n};\n"
    },
    {
        "name": "2025_11_26_000002_create_legal_agreement_versions_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_26_000002_create_legal_agreement_versions_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('legal_agreement_versions', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('legal_agreement_id')->constrained('legal_agreements')->onDelete('cascade');\n            $table->string('version');\n            $table->longText('content');\n            $table->text('change_summary')->nullable();\n            $table->enum('status', ['draft', 'review', 'active', 'archived', 'superseded'])->default('draft');\n            $table->date('effective_date')->nullable();\n            $table->integer('acceptance_count')->default(0);\n            $table->foreignId('created_by')->nullable()->constrained('users')->nullOnDelete();\n            $table->timestamps();\n\n            // Indexes\n            $table->index('legal_agreement_id');\n            $table->index(['legal_agreement_id', 'version']);\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('legal_agreement_versions');\n    }\n};\n"
    },
    {
        "name": "2025_11_26_000003_create_legal_agreement_audit_trail_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_26_000003_create_legal_agreement_audit_trail_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::create('legal_agreement_audit_trail', function (Blueprint $table) {\n            $table->id();\n            $table->foreignId('legal_agreement_id')->constrained('legal_agreements')->onDelete('cascade');\n            $table->string('event_type'); // created, updated, deleted, published, archived, viewed, shared, downloaded, version_created, status_changed, accepted, declined\n            $table->text('description');\n            $table->json('changes')->nullable(); // Store before/after values\n            $table->string('version')->nullable();\n            $table->foreignId('user_id')->nullable()->constrained('users')->nullOnDelete();\n            $table->string('user_name')->nullable();\n            $table->string('ip_address')->nullable();\n            $table->text('user_agent')->nullable();\n            $table->timestamps();\n\n            // Indexes\n            $table->index('legal_agreement_id');\n            $table->index('event_type');\n            $table->index('user_id');\n            $table->index('created_at');\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::dropIfExists('legal_agreement_audit_trail');\n    }\n};\n"
    },
    {
        "name": "2025_11_26_000004_update_user_legal_acceptances_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_26_000004_update_user_legal_acceptances_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::table('user_legal_acceptances', function (Blueprint $table) {\n            /**\n             * Drop foreign keys first (they depend on indexes).\n             */\n            $table->dropForeign('user_legal_acceptances_user_id_foreign'); // FK on user_id\n            $table->dropForeign(['page_id']); // FK on page_id (removes its index too)\n\n            /**\n             * Drop the old unique constraint.\n             */\n            $table->dropUnique('user_legal_acceptances_user_id_page_id_page_version_unique');\n\n            /**\n             * Modify page_id to be nullable.\n             */\n            $table->unsignedBigInteger('page_id')->nullable()->change();\n\n            /**\n             * Add new columns.\n             */\n            $table->foreignId('legal_agreement_id')\n                  ->nullable()\n                  ->after('page_id')\n                  ->constrained('legal_agreements')\n                  ->onDelete('cascade');\n\n            $table->string('document_type')->nullable()->after('legal_agreement_id');\n            $table->string('accepted_version')->nullable()->after('page_version');\n            $table->text('user_agent')->nullable()->after('ip_address');\n\n            /**\n             * Add new indexes.\n             */\n            $table->index('legal_agreement_id');\n            $table->index('document_type');\n            $table->index(['user_id', 'document_type']);\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::table('user_legal_acceptances', function (Blueprint $table) {\n            /**\n             * Drop new foreign key and columns.\n             */\n            $table->dropForeign(['legal_agreement_id']);\n            $table->dropColumn(['legal_agreement_id', 'document_type', 'accepted_version', 'user_agent']);\n\n            /**\n             * Restore page_id to NOT NULL.\n             */\n            $table->unsignedBigInteger('page_id')->nullable(false)->change();\n\n            /**\n             * Restore old unique constraint.\n             */\n            $table->unique(['user_id', 'page_id', 'page_version']);\n\n            /**\n             * Restore old foreign keys.\n             */\n            $table->foreign('user_id')\n                  ->references('id')\n                  ->on('users')\n                  ->onDelete('cascade');\n\n            // IMPORTANT: adjust the referenced table name if page_id points elsewhere\n            $table->foreign('page_id')\n                  ->references('id')\n                  ->on('pages') // <-- change 'pages' if your schema uses a different table\n                  ->onDelete('cascade');\n        });\n    }\n};\n"
    },
    {
        "name": "2025_11_26_120000_add_additional_performance_indexes.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_26_120000_add_additional_performance_indexes.php",
        "content": "<?php\n// V-PERFORMANCE-INDEXES-PHASE4 - Additional performance indexes for frequently queried columns\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     */\n    public function up(): void\n    {\n        // Support tickets table indexes\n        if (Schema::hasTable('support_tickets')) {\n            Schema::table('support_tickets', function (Blueprint $table) {\n                // Index for user's tickets filtered by status\n                if ($this->hasColumn('support_tickets', 'user_id') && $this->hasColumn('support_tickets', 'status')) {\n                    if (!$this->hasIndex('support_tickets', 'support_tickets_user_status_index')) {\n                        $table->index(['user_id', 'status'], 'support_tickets_user_status_index');\n                    }\n                }\n\n                // Index for admin views sorted by status and created_at\n                if ($this->hasColumn('support_tickets', 'status') && $this->hasColumn('support_tickets', 'created_at')) {\n                    if (!$this->hasIndex('support_tickets', 'support_tickets_status_created_index')) {\n                        $table->index(['status', 'created_at'], 'support_tickets_status_created_index');\n                    }\n                }\n\n                // Index for assigned tickets\n                if ($this->hasColumn('support_tickets', 'assigned_to')) {\n                    if (!$this->hasIndex('support_tickets', 'support_tickets_assigned_index')) {\n                        $table->index('assigned_to', 'support_tickets_assigned_index');\n                    }\n                }\n\n                // Index for category filtering\n                if ($this->hasColumn('support_tickets', 'category')) {\n                    if (!$this->hasIndex('support_tickets', 'support_tickets_category_index')) {\n                        $table->index('category', 'support_tickets_category_index');\n                    }\n                }\n            });\n        }\n\n        // Support messages table indexes\n        if (Schema::hasTable('support_messages')) {\n            Schema::table('support_messages', function (Blueprint $table) {\n                // Index for ticket's messages\n                if ($this->hasColumn('support_messages', 'ticket_id') && $this->hasColumn('support_messages', 'created_at')) {\n                    if (!$this->hasIndex('support_messages', 'support_messages_ticket_created_index')) {\n                        $table->index(['ticket_id', 'created_at'], 'support_messages_ticket_created_index');\n                    }\n                }\n            });\n        }\n\n        // Payments table - paid_at is frequently used for revenue reporting\n        if (Schema::hasTable('payments')) {\n            Schema::table('payments', function (Blueprint $table) {\n                // Index for date-based revenue queries\n                if ($this->hasColumn('payments', 'paid_at')) {\n                    if (!$this->hasIndex('payments', 'payments_paid_at_index')) {\n                        $table->index('paid_at', 'payments_paid_at_index');\n                    }\n                }\n\n                // Composite index for revenue reporting (status + paid_at)\n                if ($this->hasColumn('payments', 'status') && $this->hasColumn('payments', 'paid_at')) {\n                    if (!$this->hasIndex('payments', 'payments_status_paid_at_index')) {\n                        $table->index(['status', 'paid_at'], 'payments_status_paid_at_index');\n                    }\n                }\n            });\n        }\n\n        // Email templates table - frequently queried by type\n        if (Schema::hasTable('email_templates')) {\n            Schema::table('email_templates', function (Blueprint $table) {\n                if ($this->hasColumn('email_templates', 'type')) {\n                    if (!$this->hasIndex('email_templates', 'email_templates_type_index')) {\n                        $table->index('type', 'email_templates_type_index');\n                    }\n                }\n            });\n        }\n\n        // Products table - slug is used for lookups\n        if (Schema::hasTable('products')) {\n            Schema::table('products', function (Blueprint $table) {\n                if ($this->hasColumn('products', 'slug')) {\n                    if (!$this->hasIndex('products', 'products_slug_index')) {\n                        $table->index('slug', 'products_slug_index');\n                    }\n                }\n            });\n        }\n\n        // Plans table - status for active plans lookup\n        if (Schema::hasTable('plans')) {\n            Schema::table('plans', function (Blueprint $table) {\n                if ($this->hasColumn('plans', 'status')) {\n                    if (!$this->hasIndex('plans', 'plans_status_index')) {\n                        $table->index('status', 'plans_status_index');\n                    }\n                }\n            });\n        }\n\n        // Referrals table indexes\n        if (Schema::hasTable('referrals')) {\n            Schema::table('referrals', function (Blueprint $table) {\n                // Index for referrer's referrals\n                if ($this->hasColumn('referrals', 'referrer_id') && $this->hasColumn('referrals', 'status')) {\n                    if (!$this->hasIndex('referrals', 'referrals_referrer_status_index')) {\n                        $table->index(['referrer_id', 'status'], 'referrals_referrer_status_index');\n                    }\n                }\n\n                // Index for referred user\n                if ($this->hasColumn('referrals', 'referred_id')) {\n                    if (!$this->hasIndex('referrals', 'referrals_referred_index')) {\n                        $table->index('referred_id', 'referrals_referred_index');\n                    }\n                }\n            });\n        }\n\n        // Blog posts table - status and published_at for public queries\n        if (Schema::hasTable('blog_posts')) {\n            Schema::table('blog_posts', function (Blueprint $table) {\n                if ($this->hasColumn('blog_posts', 'status') && $this->hasColumn('blog_posts', 'published_at')) {\n                    if (!$this->hasIndex('blog_posts', 'blog_posts_status_published_index')) {\n                        $table->index(['status', 'published_at'], 'blog_posts_status_published_index');\n                    }\n                }\n\n                if ($this->hasColumn('blog_posts', 'slug')) {\n                    if (!$this->hasIndex('blog_posts', 'blog_posts_slug_index')) {\n                        $table->index('slug', 'blog_posts_slug_index');\n                    }\n                }\n            });\n        }\n\n        // Personal access tokens - frequently queried by tokenable\n        if (Schema::hasTable('personal_access_tokens')) {\n            Schema::table('personal_access_tokens', function (Blueprint $table) {\n                if ($this->hasColumn('personal_access_tokens', 'tokenable_id') && $this->hasColumn('personal_access_tokens', 'tokenable_type')) {\n                    if (!$this->hasIndex('personal_access_tokens', 'pat_tokenable_index')) {\n                        $table->index(['tokenable_type', 'tokenable_id'], 'pat_tokenable_index');\n                    }\n                }\n            });\n        }\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void\n    {\n        $this->dropIndexSafely('support_tickets', 'support_tickets_user_status_index');\n        $this->dropIndexSafely('support_tickets', 'support_tickets_status_created_index');\n        $this->dropIndexSafely('support_tickets', 'support_tickets_assigned_index');\n        $this->dropIndexSafely('support_tickets', 'support_tickets_category_index');\n\n        $this->dropIndexSafely('support_messages', 'support_messages_ticket_created_index');\n\n        $this->dropIndexSafely('payments', 'payments_paid_at_index');\n        $this->dropIndexSafely('payments', 'payments_status_paid_at_index');\n\n        $this->dropIndexSafely('email_templates', 'email_templates_type_index');\n\n        $this->dropIndexSafely('products', 'products_slug_index');\n\n        $this->dropIndexSafely('plans', 'plans_status_index');\n\n        $this->dropIndexSafely('referrals', 'referrals_referrer_status_index');\n        $this->dropIndexSafely('referrals', 'referrals_referred_index');\n\n        $this->dropIndexSafely('blog_posts', 'blog_posts_status_published_index');\n        $this->dropIndexSafely('blog_posts', 'blog_posts_slug_index');\n\n        $this->dropIndexSafely('personal_access_tokens', 'pat_tokenable_index');\n    }\n\n    /**\n     * Check if an index exists on a table\n     */\n    private function hasIndex(string $table, string $indexName): bool\n    {\n        try {\n            $indexes = Schema::getIndexes($table);\n            foreach ($indexes as $index) {\n                if ($index['name'] === $indexName) {\n                    return true;\n                }\n            }\n        } catch (\\Exception $e) {\n            // Table might not exist or other error\n        }\n        return false;\n    }\n\n    /**\n     * Check if a column exists on a table\n     */\n    private function hasColumn(string $table, string $column): bool\n    {\n        return Schema::hasColumn($table, $column);\n    }\n\n    /**\n     * Safely drop an index if it exists\n     */\n    private function dropIndexSafely(string $table, string $indexName): void\n    {\n        if (Schema::hasTable($table) && $this->hasIndex($table, $indexName)) {\n            Schema::table($table, function (Blueprint $table) use ($indexName) {\n                $table->dropIndex($indexName);\n            });\n        }\n    }\n};\n"
    },
    {
        "name": "2025_11_28_180400_add_timestamps_to_product_highlights_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_28_180400_add_timestamps_to_product_highlights_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     */\n    public function up(): void\n    {\n        Schema::table('product_highlights', function (Blueprint $table) {\n            $table->timestamps();\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void\n    {\n        Schema::table('product_highlights', function (Blueprint $table) {\n            $table->dropTimestamps();\n        });\n    }\n};\n"
    },
    {
        "name": "2025_11_28_180912_add_missing_timestamps_to_product_tables.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_28_180912_add_missing_timestamps_to_product_tables.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up()\n    {\n        $tables = [\n            'products',\n            'product_price_histories',\n            'product_risk_disclosures',\n            'product_key_metrics',\n            'product_funding_rounds',\n            'product_founders',\n            'product_highlights',\n        ];\n\n        foreach ($tables as $tableName) {\n            if (Schema::hasTable($tableName)) { // <-- prevents errors\n                Schema::table($tableName, function (Blueprint $table) use ($tableName) {\n                    if (!Schema::hasColumn($tableName, 'created_at')) {\n                        $table->timestamps();\n                    }\n                });\n            }\n        }\n    }\n\n    public function down()\n    {\n        $tables = [\n            'products',\n            'product_price_histories',\n            'product_risk_disclosures',\n            'product_key_metrics',\n            'product_funding_rounds',\n            'product_founders',\n            'product_highlights',\n        ];\n\n        foreach ($tables as $tableName) {\n            if (Schema::hasTable($tableName)) {\n                Schema::table($tableName, function (Blueprint $table) {\n                    $table->dropTimestamps();\n                });\n            }\n        }\n    }\n};\n"
    },
    {
        "name": "2025_11_28_202316_add_bank_fields_to_withdrawals_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_28_202316_add_bank_fields_to_withdrawals_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::table('withdrawals', function (Blueprint $table) {\n            $table->string('bank_account_number')->nullable();\n            $table->string('bank_ifsc')->nullable();\n            $table->string('bank_name')->nullable();\n            $table->string('account_holder_name')->nullable();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::table('withdrawals', function (Blueprint $table) {\n            $table->dropColumn([\n                'bank_account_number',\n                'bank_ifsc',\n                'bank_name',\n                'account_holder_name',\n            ]);\n        });\n    }\n};\n"
    },
    {
        "name": "2025_11_28_203457_add_requested_at_to_withdrawals_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_28_203457_add_requested_at_to_withdrawals_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::table('withdrawals', function (Blueprint $table) {\n            $table->timestamp('requested_at')->nullable()->after('account_holder_name');\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::table('withdrawals', function (Blueprint $table) {\n            $table->dropColumn('requested_at');\n        });\n    }\n};\n"
    },
    {
        "name": "2025_11_28_203813_make_bank_details_nullable_in_withdrawals_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_28_203813_make_bank_details_nullable_in_withdrawals_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::table('withdrawals', function (Blueprint $table) {\n            $table->json('bank_details')->nullable()->change();\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::table('withdrawals', function (Blueprint $table) {\n            $table->json('bank_details')->change(); // will revert to NOT NULL\n        });\n    }\n};\n"
    },
    {
        "name": "2025_11_28_204255_add_investment_fields_to_user_investments_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_28_204255_add_investment_fields_to_user_investments_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    public function up(): void\n    {\n        Schema::table('user_investments', function (Blueprint $table) {\n            if (!Schema::hasColumn('user_investments', 'shares')) {\n                $table->integer('shares')->nullable();\n            }\n\n            if (!Schema::hasColumn('user_investments', 'price_per_share')) {\n                $table->decimal('price_per_share', 10, 2)->nullable();\n            }\n\n            if (!Schema::hasColumn('user_investments', 'total_amount')) {\n                $table->decimal('total_amount', 12, 2)->nullable();\n            }\n\n            if (!Schema::hasColumn('user_investments', 'source')) {\n                $table->string('source')->default('sip');\n            }\n\n            if (!Schema::hasColumn('user_investments', 'status')) {\n                $table->string('status')->default('active');\n            }\n\n            if (!Schema::hasColumn('user_investments', 'allocated_at')) {\n                $table->timestamp('allocated_at')->nullable();\n            }\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::table('user_investments', function (Blueprint $table) {\n            $table->dropColumn([\n                'shares',\n                'price_per_share',\n                'total_amount',\n                'source',\n                'status',\n                'allocated_at',\n            ]);\n        });\n    }\n};\n"
    },
    {
        "name": "2025_11_28_212417_add_exited_at_to_user_investments_table.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_28_212417_add_exited_at_to_user_investments_table.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration {\n    public function up(): void\n    {\n        Schema::table('user_investments', function (Blueprint $table) {\n            $table->timestamp('exited_at')->nullable()->after('allocated_at');\n        });\n    }\n\n    public function down(): void\n    {\n        Schema::table('user_investments', function (Blueprint $table) {\n            $table->dropColumn('exited_at');\n        });\n    }\n};\n"
    },
    {
        "name": "2025_11_28_212832_make_value_allocated_nullable_in_user_investments.php",
        "path": "C:\\PreIPO\\backend\\database\\migrations\\2025_11_28_212832_make_value_allocated_nullable_in_user_investments.php",
        "content": "<?php\n\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\n\nreturn new class extends Migration\n{\n    /**\n     * Run the migrations.\n     */\n    public function up(): void\n    {\n        Schema::table('user_investments', function (Blueprint $table) {\n               $table->decimal('value_allocated', 15, 2)->nullable()->change();\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     */\n    public function down(): void\n    {\n        Schema::table('user_investments', function (Blueprint $table) {\n            $table->dropColumn('value_allocated');\n        });\n    }\n};\n"
    }
]