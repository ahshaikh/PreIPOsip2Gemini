<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use App\Models\User;
use App\Models\UserProfile;
use App\Models\UserKyc;
use App\Models\KycDocument;
use App\Models\Product;
use App\Models\ProductHighlight;
use App\Models\ProductFounder;
use App\Models\ProductFundingRound;
use App\Models\ProductKeyMetric;
use App\Models\ProductRiskDisclosure;
use App\Models\ProductPriceHistory;
use App\Models\Plan;
use App\Models\PlanFeature;
use App\Models\PlanConfig;
use App\Models\Subscription;
use App\Models\Payment;
use App\Models\Wallet;
use App\Models\Transaction;
use App\Models\Withdrawal;
use App\Models\UserInvestment;
use App\Models\BulkPurchase;
use App\Models\BonusTransaction;
use App\Models\ReferralCampaign;
use App\Models\Referral;
use App\Models\SupportTicket;
use App\Models\SupportMessage;
use App\Models\Page;
use App\Models\BlogPost;
use App\Models\Menu;
use App\Models\MenuItem;
use App\Models\Banner;
use App\Models\KbCategory;
use App\Models\KbArticle;
use App\Models\Redirect;
use App\Models\ActivityLog;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Str;
use Spatie\Permission\Models\Role;
use Spatie\Permission\Models\Permission;

class ComprehensiveFakerSeeder extends Seeder
{
    public function run(): void
    {
        $this->command->info('ðŸŒ± Starting comprehensive database seeding...');

        // Create Roles
        $this->seedRolesAndPermissions();

        // Admins
        $this->command->info('Creating admin users...');
        $admins = $this->seedAdminUsers();

        // Regular Users
        $this->command->info('Creating regular users...');
        $users = $this->seedRegularUsers();

        // Public Users
        $this->command->info('Creating public users...');
        $publicUsers = $this->seedPublicUsers();

        $allUsers = collect($admins)->merge($users)->merge($publicUsers);

        // Products
        $this->command->info('Creating products...');
        $products = $this->seedProducts();

        // Plans
        $this->command->info('Creating plans...');
        $plans = $this->seedPlans();

        // Bulk Purchases
        $this->command->info('Creating bulk purchases...');
        $this->seedBulkPurchases($products, $admins);

        // Subscriptions & Payments
        $this->command->info('Creating subscriptions & payments...');
        $subscriptions = $this->seedSubscriptionsAndPayments($users, $plans);

        // Wallets & Transactions
        $this->command->info('Creating wallet transactions...');
        $this->seedWalletTransactions($allUsers);

        // Withdrawals
        $this->command->info('Creating withdrawals...');
        $this->seedWithdrawals($users, $admins);

        // User Investments
        $this->command->info('Creating user investments...');
        $this->seedUserInvestments($users, $products, $subscriptions);

        // Bonus & Referrals
        $this->command->info('Creating referral & bonus data...');
        $this->seedBonusAndReferrals($users, $subscriptions);

        // Support System
        $this->command->info('Creating support tickets...');
        $this->seedSupportSystem($allUsers, $admins);

        // Pages
        $this->command->info('Creating CMS pages...');
        $this->seedPages();

        // Blog
        $this->command->info('Creating blog posts...');
        $this->seedBlogPosts($admins);

        // Menus
        $this->command->info('Creating menus...');
        $this->seedMenus();

        // Banners
        $this->command->info('Creating banners...');
        $this->seedBanners();

        // Knowledge Base
        $this->command->info('Creating knowledge base...');
        $this->seedKnowledgeBase($admins);

        // Redirects
        $this->command->info('Creating redirects...');
        $this->seedRedirects();

        // Activity Logs
        $this->command->info('Creating activity logs...');
        $this->seedActivityLogs($allUsers);

        // Notifications
        $this->command->info('Creating notifications...');
        $this->seedNotifications($allUsers);

        $this->command->info('âœ… Seeding completed successfully!');
    }

    private function seedRolesAndPermissions(): void
    {
        if (!Role::where('name', 'admin')->exists()) {
            Role::create(['name' => 'admin']);
        }
        if (!Role::where('name', 'user')->exists()) {
            Role::create(['name' => 'user']);
        }
        if (!Role::where('name', 'manager')->exists()) {
            Role::create(['name' => 'manager']);
        }
    }

    private function seedAdminUsers(): array
    {
        $admins = [];

        $super = User::create([
            'username' => 'superadmin',
            'email' => 'admin@preipo.com',
            'mobile' => '9999999999',
            'password' => Hash::make('password'),
            'email_verified_at' => now(),
            'mobile_verified_at' => now(),
            'referral_code' => Str::upper(Str::random(10)),
            'status' => 'active',
        ]);
        $super->assignRole('admin');
        $this->createUserProfile($super, 'Super', 'Admin');
        $this->createUserKyc($super, 'verified');
        $admins[] = $super;

        for ($i = 1; $i <= 2; $i++) {
            $admin = User::create([
                'username' => 'admin' . $i,
                'email' => 'admin' . $i . '@preipo.com',
                'mobile' => '999999999' . $i,
                'password' => Hash::make('password'),
                'email_verified_at' => now(),
                'mobile_verified_at' => now(),
                'referral_code' => Str::upper(Str::random(10)),
                'status' => 'active',
            ]);

            $admin->assignRole('admin');
            $this->createUserProfile($admin, 'Admin', 'User ' . $i);
            $this->createUserKyc($admin, 'verified');
            $admins[] = $admin;
        }

        return $admins;
    }


    private function seedRegularUsers(): array
    {
        $users = [];

        for ($i = 1; $i <= 50; $i++) {
            $user = User::create([
                'username' => 'user' . $i,
                'email' => 'user' . $i . '@example.com',
                'mobile' => '9' . str_pad($i, 9, '0', STR_PAD_LEFT),
                'password' => Hash::make('password'),
                'email_verified_at' => now(),
                'mobile_verified_at' => now(),
                'referral_code' => Str::upper(Str::random(10)),
                'status' => 'active',
            ]);

            $user->assignRole('user');
            $this->createUserProfile($user, 'User', 'Number ' . $i);

            $status = fake()->randomElement(['verified', 'submitted', 'pending', 'rejected']);
            $this->createUserKyc($user, $status);

            $users[] = $user;
        }

        return $users;
    }

    private function seedPublicUsers(): array
    {
        $publicUsers = [];

        for ($i = 1; $i <= 20; $i++) {
            $user = User::create([
                'username' => 'guest' . $i,
                'email' => 'guest' . $i . '@example.com',
                'mobile' => '8' . str_pad($i, 9, '0', STR_PAD_LEFT),
                'password' => Hash::make('password'),
                'email_verified_at' => null,
                'mobile_verified_at' => null,
                'referral_code' => Str::upper(Str::random(10)),
                'status' => 'pending',
            ]);

            $this->createUserProfile($user, 'Guest', 'User ' . $i);
            $this->createUserKyc($user, 'pending');

            $publicUsers[] = $user;
        }

        return $publicUsers;
    }

    private function createUserProfile(User $user, string $first, string $last): void
    {
        UserProfile::create([
            'user_id' => $user->id,
            'first_name' => $first,
            'last_name' => $last,
            'dob' => fake()->date('Y-m-d', '-21 years'),
            'gender' => fake()->randomElement(['male', 'female', 'other']),
            'address_line_1' => fake()->streetAddress(),
            'address_line_2' => fake()->secondaryAddress(),
            'city' => fake()->city(),
            'state' => fake()->state(),
            'pincode' => fake()->numerify('######'),
            'country' => 'India',
        ]);
    }

    private function createUserKyc(User $user, string $status): void
    {
        $kyc = UserKyc::create([
            'user_id' => $user->id,
            'pan_number' => strtoupper(fake()->bothify('?????####?')),
            'aadhaar_number' => fake()->numerify('############'),
            'demat_account' => fake()->numerify('IN##########'),
            'bank_account' => fake()->numerify('##############'),
            'bank_ifsc' => strtoupper(fake()->bothify('????0######')),
            'status' => $status,
            'verified_at' => $status === 'verified' ? now() : null,
            'submitted_at' => in_array($status, ['verified', 'submitted', 'rejected'])
                ? now()->subDays(2)
                : null,
            'rejection_reason' => $status === 'rejected'
                ? 'Documents not clear'
                : null,
        ]);

        if (in_array($status, ['verified', 'submitted', 'rejected'])) {
            foreach (['pan_card', 'aadhaar_front', 'aadhaar_back'] as $doc) {
                KycDocument::create([
                    'user_kyc_id' => $kyc->id,
                    'doc_type' => $doc,
                    'file_path' => 'kyc/' . fake()->uuid() . '.pdf',
                    'file_name' => $doc . '.pdf',
                    'mime_type' => 'application/pdf',
                    'status' => $status === 'verified'
                        ? 'approved'
                        : ($status === 'rejected' ? 'rejected' : 'pending'),
                    'verified_at' => $status === 'verified' ? now() : null,
                ]);
            }
        }
    }

    private function seedProducts(): array
    {
        $products = Product::factory(15)->create();

        foreach ($products as $product) {

            ProductHighlight::factory(rand(3, 5))->create([
                'product_id' => $product->id
            ]);

            ProductFounder::factory(rand(2, 4))->create([
                'product_id' => $product->id
            ]);

            ProductFundingRound::factory(rand(2, 5))->create([
                'product_id' => $product->id
            ]);

            ProductKeyMetric::factory(rand(4, 8))->create([
                'product_id' => $product->id
            ]);

            ProductRiskDisclosure::factory(rand(3, 6))->create([
                'product_id' => $product->id
            ]);

            // Unique price history
            $count = rand(10, 30);
            $dates = collect(range(1, 365))
                ->shuffle()
                ->take($count)
                ->map(fn ($d) => now()->subDays($d)->format('Y-m-d'));

            foreach ($dates as $date) {
                ProductPriceHistory::create([
                    'product_id' => $product->id,
                    'price' => fake()->randomFloat(2, 100, 5000),
                    'recorded_at' => $date,
                ]);
            }
        }

        return $products->all();
    }

    private function seedPlans(): array
    {
        $plans = Plan::factory(5)->create();

        foreach ($plans as $plan) {
            PlanFeature::factory(rand(5, 10))->create([
                'plan_id' => $plan->id
            ]);

            $keys = ['bonus_multiplier', 'transaction_fee', 'withdrawal_limit', 'features', 'benefits'];

            foreach (array_slice($keys, 0, rand(3, 5)) as $key) {
                PlanConfig::create([
                    'plan_id' => $plan->id,
                    'config_key' => $key,
                    'value' => json_encode([
                        'enabled' => true,
                        'value' => rand(1, 100)
                    ]),
                ]);
            }
        }

        return $plans->all();
    }

    private function seedBulkPurchases(array $products, array $admins): void
    {
        foreach (array_slice($products, 0, 10) as $product) {
            BulkPurchase::factory()->create([
                'product_id' => $product->id,
                'admin_id' => fake()->randomElement($admins)->id,
            ]);
        }
    }

    private function seedSubscriptionsAndPayments(array $users, array $plans): array
    {
        $records = [];

        foreach (array_slice($users, 0, 40) as $user) {
            $plan = fake()->randomElement($plans);

            $subscription = Subscription::factory()->create([
                'user_id' => $user->id,
                'plan_id' => $plan->id,
                'amount' => $plan->monthly_amount,
            ]);

            $records[] = $subscription;

            $count = rand(1, 12);
            for ($i = 0; $i < $count; $i++) {
                Payment::factory()->create([
                    'user_id' => $user->id,
                    'subscription_id' => $subscription->id,
                    'amount' => $plan->monthly_amount,
                    'status' => fake()->randomElement(['completed', 'completed', 'pending', 'failed']),
                    'paid_at' => $i < $count - 1
                        ? now()->subMonths($count - $i - 1)
                        : null,
                ]);
            }
        }

        return $records;
    }

    private function seedWalletTransactions(iterable $users): void
    {
        foreach ($users as $user) {
            $wallet = Wallet::firstOrCreate(
                ['user_id' => $user->id],
                [
                    'balance' => fake()->randomFloat(2, 0, 50000),
                    'locked_balance' => fake()->randomFloat(2, 0, 5000),
                ]
            );

            for ($i = 0; $i < rand(5, 15); $i++) {
                Transaction::factory()->create([
                    'user_id' => $user->id,
                    'wallet_id' => $wallet->id,
                ]);
            }
        }
    }

    private function seedWithdrawals(array $users, array $admins): void
    {
        for ($i = 0; $i < 20; $i++) {
            $user = fake()->randomElement($users);
            $w = Wallet::where('user_id', $user->id)->first();

            if ($w) {
                Withdrawal::factory()->create([
                    'user_id' => $user->id,
                    'wallet_id' => $w->id,
                    'admin_id' => fake()->randomElement($admins)->id,
                ]);
            }
        }
    }

    private function seedUserInvestments(array $users, array $products, array $subscriptions): void
    {
        foreach (array_slice($users, 0, 30) as $user) {

            for ($i = 0; $i < rand(2, 8); $i++) {

                $product = fake()->randomElement($products);
                $subscription = fake()->randomElement($subscriptions);

                $payment = Payment::where('subscription_id', $subscription->id)
                    ->where('status', 'completed')
                    ->first();

                $bulk = BulkPurchase::where('product_id', $product->id)->first();

                if ($payment && $bulk) {
                    UserInvestment::factory()->create([
                        'user_id' => $user->id,
                        'product_id' => $product->id,
                        'payment_id' => $payment->id,
                        'bulk_purchase_id' => $bulk->id,
                    ]);
                }
            }
        }
    }

    private function seedBonusAndReferrals(array $users, array $subscriptions): void
    {
        $campaigns = ReferralCampaign::factory(3)->create();

        foreach (array_slice($users, 0, 20) as $i => $user) {
            if ($i > 0) {
                Referral::factory()->create([
                    'referrer_id' => $users[$i - 1]->id,
                    'referred_id' => $user->id,
                    'referral_campaign_id' => fake()->randomElement($campaigns)->id,
                ]);
            }
        }

        foreach (array_slice($subscriptions, 0, 30) as $sub) {
            $payment = Payment::where('subscription_id', $sub->id)
                ->where('status', 'completed')->first();

            if ($payment) {
                BonusTransaction::factory()->create([
                    'user_id' => $sub->user_id,
                    'subscription_id' => $sub->id,
                    'payment_id' => $payment->id,
                ]);
            }
        }
    }

    private function seedSupportSystem(iterable $users, array $admins): void
    {
        for ($i = 0; $i < 40; $i++) {
            $user = fake()->randomElement($users);

        // create ticket without 'description' (table doesn't have that column)
        $ticket = SupportTicket::factory()->create([
            'user_id'    => $user->id,
            // optionally assign to an admin 70% of the time
            'assigned_to' => fake()->optional(0.7)->randomElement($admins)?->id,
            // subject already provided by factory; override if you want different text:
            // 'subject' => fake()->sentence(8),
            ]);

            for ($j = 0; $j < rand(1, 8); $j++) {
                SupportMessage::factory()->create([
                    'support_ticket_id' => $ticket->id,
                    'user_id' => $j % 2 === 0
                        ? $user->id
                        : fake()->randomElement($admins)->id,
                ]);
            }
        }
    }

    private function seedPages(): void
    {
        Page::factory(15)->create();
    }

    private function seedBlogPosts(array $admins): void
    {
        BlogPost::factory(25)->create([
            'author_id' => fake()->randomElement($admins)->id,
        ]);
    }

    private function seedMenus(): void
    {
        $menus = Menu::factory(3)->create();

        foreach ($menus as $menu) {
            MenuItem::factory(rand(5, 10))->create([
                'menu_id' => $menu->id
            ]);
        }
    }

    private function seedBanners(): void
    {
        Banner::factory(5)->create();
    }

    private function seedKnowledgeBase(array $admins): void
    {
        $cats = KbCategory::factory(5)->create();

        foreach ($cats as $cat) {
            KbArticle::factory(rand(3, 8))->create([
                'kb_category_id' => $cat->id,
                'author_id' => fake()->randomElement($admins)->id,
            ]);
        }
    }

    private function seedRedirects(): void
    {
        Redirect::factory(10)->create();
    }

    private function seedActivityLogs(array $users): void
    {
        foreach ($users as $user) {
            ActivityLog::factory(rand(2, 10))->create([
                'user_id' => $user->id
            ]);
        }
    }

    private function seedNotifications(array $users): void
    {
        foreach (array_slice($users, 0, 30) as $user) {
            for ($i = 0; $i < rand(2, 8); $i++) {
                \DB::table('notifications')->insert([
                    'id' => Str::uuid(),
                    'type' => fake()->randomElement([
                        'App\\Notifications\\InvestmentConfirmed',
                        'App\\Notifications\\KYCVerified',
                        'App\\Notifications\\PaymentReceived',
                        'App\\Notifications\\SubscriptionCreated',
                        'App\\Notifications\\WithdrawalProcessed',
                    ]),
                    'notifiable_type' => User::class,
                    'notifiable_id' => $user->id,
                    'data' => json_encode([
                        'title' => fake()->sentence(4),
                        'message' => fake()->sentence(10),
                        'action_url' => fake()->optional()->url(),
                    ]),
                    'read_at' => fake()->optional()->dateTimeBetween('-30 days', 'now'),
                    'created_at' => now(),
                    'updated_at' => now(),
                ]);
            }
        }
    }
}
