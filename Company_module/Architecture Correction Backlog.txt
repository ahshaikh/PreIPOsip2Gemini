PreIPOsip – Architecture Correction Backlog
Source of Truth: Master Architecture Correction Plan (Authority-first design)

EPIC 1 — Restore Company Actor Authority (FOUNDATIONAL)
Goal: Make CompanyUsers real, role-bound, auditable actors.
Blocking: ALL other epics
User impact: None (internal only)

STORY 1.1 — Fix Company ↔ CompanyUser Domain Relationship

Description
Correct the domain model so a Company owns CompanyUsers (not retail Users).

Tasks
- Remove Company::users() relationship pointing to User
- Add Company::companyUsers(): hasMany(CompanyUser::class)
- Verify CompanyUser has company_id foreign key
- Remove any accidental joins between Company and retail User

Acceptance Criteria
- A Company can return multiple CompanyUsers
- Retail users are no longer reachable via Company relationships
- All company-authored actions can be scoped via company_id

Invariant
- ❌ A Company must never reference retail User

STORY 1.2 — Introduce Company-Scoped Roles & Guards
Description
Implement company-specific roles using Spatie, isolated from admin and retail roles.

Tasks
- Add new auth guard: company_api
- Configure CompanyUser to use HasRoles
- Seed roles:
  - company_admin
  - company_finance
  - company_legal
  - company_marketing
  - company_viewer

Acceptance Criteria
- Roles are scoped to company_api
- Company roles cannot be assigned to admin or retail users
- Role checks work via middleware

Invariant
- ❌ Admin roles must never be reused for company users

STORY 1.3 — Company User Management APIs (No UI Yet)
Description
Allow company admins to manage their internal team via API.

Endpoints
- GET /api/v1/company/users
- POST /api/v1/company/users
- PUT /api/v1/company/users/{id}
- DELETE /api/v1/company/users/{id} (soft revoke)

Rules
- Only company_admin can manage users
- Users are always created with same company_id
- No admin override endpoints

Acceptance Criteria
- Company admins can manage users via API
- All actions are auditable per CompanyUser
- No cross-company access possible

Invariant
- ❌ Admins must NOT manage company users

EPIC 2 — Restore Product Ownership & Authorship
Goal: Products are company-authored; admins only approve
Depends on: EPIC 1

STORY 2.1 — Add Company Ownership to Products
Description
Every product must belong to exactly one Company.

Tasks
- Add company_id to products table
- Backfill existing products safely (admin-owned → mapped company)
- Add Product::company() relationship

Acceptance Criteria
- No product exists without company_id
- Product ownership is queryable and enforced

Invariant
- ❌ Products without company ownership are invalid

Let’s re-run Story 2.2 with zero schema changes.
STORY 2.2 — Introduce Product Lifecycle States
States
- draft
- submitted
- approved
- rejected
- locked

Rules
- CompanyUsers can edit only in draft
- Submission moves product → submitted
- Admin can approve/reject only
- Once inventory exists → locked

Acceptance Criteria
- State transitions enforced server-side
- Illegal transitions throw errors

Invariant
- ❌ Admins never edit product content

STORY 2.3 — Company Product APIs (Authorship)
Endpoints
- POST /api/v1/company/products
- PUT /api/v1/company/products/{id}
- POST /api/v1/company/products/{id}/submit

Rules
- Only owning company can mutate
- Only company_admin can submit

Acceptance Criteria
- Products are created by companies only
- Admin routes cannot create products

STORY 2.4 — Admin Product Approval Queue
Description
Admin reviews, but never authors, product data.

Endpoints / Screens
- List products where status = submitted
- View product (read-only)
- Approve → approved
- Reject → rejected (with reason)

Acceptance Criteria
- Admin edits are impossible
- Approval actions are logged

Invariant
- ❌ Admins are reviewers, never authors

EPIC 3 — Restore Disclosure Authority (COMPLIANCE)
Goal: Public visibility must depend on verified disclosure completeness
Depends on: EPIC 2

STORY 3.1 — Add Explicit Company Disclosure Tier
Field
- companies.disclosure_tier ENUM:
  - tier_0_pending
  - tier_1_upcoming
  - tier_2_live
  - tier_3_featured

Acceptance Criteria
- Every company has exactly one tier
- Tier is immutable except via promotion logic

Invariant
- ❌ No public visibility without tier

STORY 3.2 — Tier Promotion Service (Authoritative)
Description
Promote company tier ONLY when all required disclosures are approved.

Trigger
- After CompanyDisclosure approval

Logic
- Check disclosure modules required for next tier
- Promote company atomically if complete

Acceptance Criteria
- No manual tier setting
- No skipping tiers
- Promotion is deterministic and auditable

STORY 3.3 — Refactor Public Visibility Logic
Remove
whereHas('deals', ...)

Replace
where('companies.disclosure_tier', ...)

Applies to
- Upcoming companies
- Live deals
- Featured listings

Acceptance Criteria
- Visibility matches disclosure tier exactly
- Creating a Deal does NOT change visibility

Invariant
- ❌ Deals never control visibility

EPIC 4 — Lock Commercial Boundaries (DEALS & INVENTORY)
Goal: Prevent compliance bypass via commercial actions
Depends on: EPIC 3

STORY 4.1 — Enforce Tier Gates on Deal Creation
Rules
- Deal creation allowed only if:
  - company.disclosure_tier >= tier_1
- Deal activation (sellable) only if:
  - tier_2
- Featured promotion only if:
  - tier_3

Acceptance Criteria
- Violations throw hard errors
- No silent downgrades or warnings

Invariant
- ❌ No deal exists outside compliance tiers

STORY 4.2 — Enforce Provenance on Manual Bulk Purchases
Tasks
- Make manual_entry_reason mandatory
- Require supporting documentation fields

Acceptance Criteria
- All inventory has an audit trail

STORY 4.3 — (Mandatory) Platform Ledger Linkage
Description
Link BulkPurchase creation to platform ledger debit.

Acceptance Criteria
- Inventory creation has financial provenance
- Ledger logic remains additive (no rewrite)

Invariant
- ❌ Do not refactor AllocationService

DO NOT TOUCH LIST (ABSOLUTE)
- AllocationService
- Inventory locking logic
- Pessimistic DB transactions
- User purchase flow

FINAL INSTRUCTION FOR GEMINI (IMPORTANT)
When you feed this to Gemini, precede it with:

> “You must implement these epics in order.
> Do not collapse phases.
> Do not bypass invariants.
> Do not refactor inventory logic.”


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


EPIC 5 — Frontend Reflection (GOVERNED UX)
Goal
Ensure that all compliance, disclosure, tiering, and risk controls implemented in Epics 1–4 are explicitly, consistently, and unavoidably reflected in UI across all platform roles.

This EPIC does NOT add business logic.
It projects existing authority into user experience.

Depends on
EPIC 1–4 (Disclosure Engine, Governance, Tier Authority, Commercial Locks)

STORY 5.1 — Public Frontend Projection (Unauthenticated)
Purpose
Establish platform legitimacy and education without solicitation or implied investment invitation.

Rules
- Public UI is read-only
- Public UI is platform-owned, not issuer-owned
- Public UI must not expose investor-only signals

Must Display
- Company identity (name, sector, description – sanitized)
- Controls whether a company appears on:
  - /products
  - /products?filter=live
  - all public listing views
- Platform relationship state:
  - “Listed for informational purposes”
  - “Under review” / “Not investable”
- Platform educational context (what pre-IPO investing means)

Must NEVER Display
- Prices, valuations, funding
- Risk flags, disclosure completeness
- Buy eligibility or CTA
- Language implying availability or solicitation

Acceptance Criteria
- No public page can be construed as an investment offer
- Public content never contradicts investor/admin views
- Public view degrades gracefully when company is frozen/suspended

A. Public Frontend (Unauthenticated) — Acceptance Checklist
A1. Access & Scope
- ☐ Public pages are strictly read-only
- ☐ No backend investor or admin services are called
- ☐ Public companies are listed at  /products?filter=live
- ☐ Page is accessible without authentication
- ☐ Page does not rely on investor-only or admin-only services
- ☐ All data is dynamically sourced (no hardcoded company entries)

A2. Information Visibility, Public Listing Views & Filters
- ☐ Company name is displayed
- ☐ Company logo is displayed only if platform-approved
- ☐ Sector / category is visible
- ☐ High-level description is platform-approved (not issuer-editable here)
- ☐ Headquarters and founded year shown only if approved
- ☐ Company website link is visible (external)
- ☐ The /products page must support all of the following views, driven by platform data:
  - ☐ All Deals
  - ☐ Live Deals
  - ☐ Upcoming
  - ☐ By Sector
- ☐ Filter Behavior
  - ☐ Filters are query-driven (e.g. ?filter=live, ?filter=upcoming, ?sector=fintech)
  - ☐ Filters are backed by platform-owned company status
  - ☐ No frontend hardcoding of deal state or sector logic
- ☐ Dynamic Consistency Rules
  - ☐ Newly listed companies automatically appear in applicable views
  - ☐ De-listed / removed companies automatically disappear from:
  - ☐ All Deals
  - ☐ Live Deals
  - ☐ Sector views
  - ☐ A company never appears in a view it does not qualify for

A3. Platform Relationship Disclosure
- ☐ Explicit platform statement is shown (e.g. “Listed for informational purposes”)
- ☐ No implication of investment availability
- ☐ /products renders PublicCompanyList
- ☐ Each company is rendered via a reusable company card
- ☐ Cards display only public-safe, platform-approved fields:
- ☐ Company name
- ☐ Logo (if approved)
- ☐ Sector / category
- ☐ High-level description
- ☐ No financials, no risk flags, no buy signals

A4. Prohibited Content (Hard Fail if Any Present)
- ☐ No valuation shown
- ☐ No share price shown
- ☐ No funding amounts shown
- ☐ No risk flags shown
- ☐ No platform warnings shown
- ☐ No buy eligibility signals shown
- ☐ No material change indicators shown
- ☐ No “Buy / Invest / Reserve” CTA shown

A5. Funnel Integrity
- ☐ Public pages link only to sign-up / subscribe / learn-more
- ☐ Public content does not contradict logged-in views

A6. Lifecycle & Platform Sync Guarantees
- ☐ Public pages reflect platform state in near real-time
- ☐ If a company is:
    - ☐ de-listed
    - ☐ removed
    - ☐ marked inactive
→ it disappears automatically from all public views
- ☐ Public frontend never contradicts:
  - ☐ investor frontend
  - ☐ issuer frontend
  - ☐ admin frontend

A7. Component Boundary Enforcement
- ☐ PublicCompanyList handles listing & filters only
- ☐ PublicCompanyProfile handles company-specific view only
- ☐ PublicDisclaimerBanner is reusable and enforced
- ☐ No business logic is embedded directly in page components

A8. Canonical Public Language (Non-Negotiable)
- ☐ Platform relationship states use ONLY platform-defined copy constants
- ☐ No free-text or marketing language allowed for status messaging
- ☐ Public relationship copy is sourced from a single constants file
- ☐ Any change to public wording requires compliance approval

STORY 5.2 — Investor Frontend Reflection (Subscriber / Logged-In)
Purpose
- Make investor decision-making provable, reviewable, and regulator-defensible.

- Canonical Entry Point
  - /deals is the primary investor surface

- Investor Capabilities
  - Browse multiple companies
  - Compare risk and platform context
  - Allocate wallet balance across multiple companies
  - Review before committing

- Mandatory UI Elements
  - DealsPage
    - Per-company eligibility state (enabled / blocked with reason)
    - Risk indicators clearly visible

- Company Deep Dive
  - Clicking a company opens full investor view
  - Shows ONLY approved, investor-visible data

- Company Investor View
  - Approved disclosures only
  - Platform warnings and material change notices

- Display Layers (Strict Separation)
  - Disclosures: issuer-provided, approved content
  - Risk Indicators: platform-generated, non-editable
  - Material Change Notices: time-bound alerts with timestamps

- Wallet Allocation Panel
  - Real-time balance tracking
  - Prevent over-allocation
  - Investor has a wallet balance (e.g. ₹5,000)
  - May:
       - invest full amount in one company, OR
       - split across multiple companies

- Risk Acknowledgement Flow
  - Explicit, non-skippable acknowledgements
  - Tied to allocation intent

- Investment Review Snapshot
  - Single screen summarizing:
    - Companies
    - Allocations
    - Risks
    - Acknowledgements  
  - Explicit final confirmation

- Invariants
  - ❌ No buy without disclosure tier ≥ Tier 2
  - ❌ No implicit consent
  - ❌ No “fail later” UX
  - ❌ Frontend must NEVER infer eligibility
  - ❌ Frontend must NEVER compute disclosure tier gates
  - ✅ Buy / Blocked state is rendered ONLY from backend response

- Snapshot Binding
  - On confirmation:
    - invoke InvestmentSnapshotService

- snapshot must include:
  - what the investor saw
  - platform context
  - acknowledgements
  - allocation breakdown
  - Snapshot must be immutable

- Required/possibilities TSX Files
  - DealsPage.tsx
  - DealCard.tsx
  - CompanyInvestorView.tsx
  - WalletAllocationPanel.tsx
  - RiskAcknowledgementModal.tsx
  - InvestmentReviewSnapshot.tsx
  - BuyBlockedState.tsx

- Acceptance Criteria
  - Investor cannot claim they were unaware of risks
  - Snapshot shown == snapshot stored
  - Buy CTA always reflects backend guard state

- Audit Test:
  - Given the stored InvestmentSnapshot, a third party must be able to reconstruct exactly what the investor saw and acknowledged.

B. Subscriber / Investor Frontend — Acceptance Checklist
B1. Entry & Browsing (/deals)
- ☐ Logged-in subscribers land on /deals
- ☐ All investable companies are listed
- ☐ Each company card shows:
- ☐ platform context
- ☐ risk flags
- ☐ buy eligibility state
- ☐ If buy is blocked, reason is visible (no silent blocking)

B2. Company Deep Dive
- ☐ Clicking a company opens an investor-only view
- ☐ Only approved, investor-visible data is shown
- ☐ Platform warnings are prominently displayed
- ☐ Material change notices are prominently displayed
- ☐ Governance state is visible
- ☐ Required risk acknowledgements are listed before buy

B3. Wallet & Allocation
- ☐ Wallet balance is visible
- ☐ Investor can allocate full balance to one company
- ☐ Investor can split balance across multiple companies
- ☐ UI prevents over-allocation
- ☐ Remaining balance updates in real time
- ☐ Allocation respects per-company buy guards

B4. Pre-Buy Validation
- ☐ BuyEnablementGuardService is called before confirmation
- ☐ All blockers are rendered deterministically
- ☐ No “submit then fail” UX paths exist

B5. Risk Acknowledgements
- ☐ Required acknowledgements are explicitly displayed
- ☐ Acknowledgements require explicit user action
- ☐ Acknowledgements cannot be skipped or backgrounded
- ☐ Acknowledgements are tied to the exact allocation intent

B6. Investment Review & Snapshot
- ☐ Single review screen exists before final confirmation
- ☐ Review screen shows:
- ☐ selected companies
- ☐ allocation per company
- ☐ total wallet usage
- ☐ risks and warnings
- ☐ acknowledgement status
- ☐ Investor must explicitly confirm understanding

B7. Snapshot Binding
- ☐ InvestmentSnapshotService is invoked on confirmation
- ☐ Snapshot includes:
- ☐ investor-visible company data
- ☐ platform context
- ☐ acknowledgements
- ☐ allocation breakdown
- ☐ Snapshot is immutable after creation

STORY 5.3 — Company (Issuer) Frontend Alignment
Purpose
- Transform issuer UI from a “form editor” into a constrained interface to platform governance.
- Allow issuers to submit and correct information
- Enforce platform governance
- Prevent accidental investor impact
- Issuer Frontend Rules

Platform State Supremacy
- If platform has:
  - frozen company
  - suspended buying
  - opened investigation
- Issuer UI must:
  - disable edits immediately
  - show clear explanation
  - never “fail later” on submit

Required Reflections
- Disclosure state (Draft / Under Review / Approved)
- Editability rules enforced visually
- Clarification threads clearly scoped and timed
- Draft sections: editable
- Under-review sections: conditionally editable or read-only
- Approved sections: locked unless reopened by platform
- Rejected sections: show rejection reason + guidance

Issuer Must See (Read-Only)
- Which disclosure version investors currently see
- Whether edits will:
  - affect only future investors
  - trigger material change
  - pause buying
- Effective timing of changes:
  - immediate
  - after approval
  - after next investor action

Issuer Must NOT Control
- Tier changes
- Platform warnings
- Risk flags
- Freeze / suspend logic

Issuer Acknowledgement (Non-Blocking)
- ☐ Issuer must acknowledge investor impact before submitting changes
- ☐ Acknowledgement is informational, not consent
- ☐ Stored for audit trail

Acceptance Criteria
- Issuer UI cannot bypass platform authority
- All locks are visible before submit
- Rejections always show reason and next steps

Required/Modifications TSX Files
- Modify existing issuer company profile pages
- IssuerDisclosureEditor.tsx
- PlatformStatusBanner.tsx
- IssuerInvestorImpactPanel.tsx
- ClarificationResponsePanel.tsx

Invariant (Hard)
- ❌ Issuer UI must never allow mutation of locked fields in client state
- ❌ No hidden or disabled-but-bound inputs for locked disclosures
- ✅ Locked disclosures are rendered as read-only views, not disabled forms

C. Company / Issuer Frontend — Acceptance Checklist
C1. Platform State Enforcement
- ☐ If company is frozen/suspended/investigated:
- ☐ edits are disabled immediately
- ☐ reason is clearly displayed
- ☐ UI does not allow submit-and-fail behavior

C2. Review-State-Driven Editability
- ☐ Draft sections are editable
- ☐ Under-review sections are conditionally editable or read-only
- ☐ Approved sections are locked
- ☐ Rejected sections show rejection reason
- ☐ Rejected sections provide corrective guidance

C3. Investor Impact Awareness (Read-Only)
- ☐ Issuer can see which disclosure version investors currently see
- ☐ Issuer can see whether changes will:
- ☐ affect only future investors
- ☐ trigger material change workflow
- ☐ pause buying
- ☐ Issuer cannot control any investor-impact settings

C4. Clarifications
- ☐ Issuer can respond to clarifications
- ☐ Issuer cannot close or extend clarifications
- ☐ Platform timelines and escalation are visible

STORY 5.4 — Admin Frontend Reflection
Purpose
Make platform authority explicit, intentional, and snapshot-safe.

Admin UI Must Surface
- Tier state and promotion readiness
- Disclosure completeness by tier
- Platform warnings and risk flags
- Freeze / suspend status and rationale

Admin Actions Must Show
- Investor impact count
- Buy enablement impact
- Re-acknowledgement requirements
- Snapshot immutability warnings
- Pre-action simulation preview:
  - what will change
  - what will NOT change
  - which snapshots remain untouched

Admin Acknowledgement (Non-Blocking)
- ☐ Admin must acknowledge irreversible or high-impact actions
- ☐ Acknowledgement is recorded for audit
- ☐ Acknowledgement does not delay execution

- All reconstructions must be consistent across:
  - public
  - investor
  - issuer
  - admin views

Invariants
- ❌ No silent historical mutation
- ❌ No ambiguous authority (platform vs issuer)

Acceptance Criteria
- Admin understands consequences before acting
- Past investor snapshots are visibly immutable
- Platform judgments are clearly labeled as such

GLOBAL FRONTEND INVARIANTS (NON-NEGOTIABLE)
- Backend authority must be visible, not implied
- Every role sees a role-scoped projection of the same governed company
- No UI may contradict another role’s reality
- Compliance depends on what the user saw, not what the backend enforced

D. Admin / Platform Frontend — Acceptance Checklist
D1. Platform Authority Visibility
- ☐ Admin actions are explicitly labeled as platform decisions
- ☐ No admin action is visually conflated with issuer data

D2. Investor Impact Awareness
- ☐ Before approvals/rejections/freezes, admin sees:
- ☐ number of affected investors
- ☐ buy impact (pause/resume)
- ☐ re-acknowledgement requirements

D3. Platform Context Control
- ☐ Risk flags are admin-only editable
- ☐ Tier status is admin-only editable
- ☐ Valuation context is admin-only editable
- ☐ Platform warnings are admin-only editable
- ☐ Issuer UI cannot edit any of the above

D4. Snapshot Awareness
- ☐ Admin can see frozen investor snapshots
- ☐ Admin UI clearly marks irreversible actions
- ☐ Admin can distinguish actions affecting:
- ☐ future investments only
- ☐ no past snapshots

E. Global Cross-Frontend Acceptance Criteria (Hard Gate)
- ☐ No frontend bypasses backend guards
- ☐ No frontend assumes authority not granted by platform
- ☐ No warnings are hidden behind secondary interactions
- ☐ No implicit consent flows exist
- ☐ Platform context dominates issuer and investor views
- ☐ Every user action is explainable in audit

FINAL COMPLETION TEST (EPIC 5)
EPIC 5 is complete only if:
- A regulator can reconstruct:
  - what an investor saw
  - what they acknowledged
  - why they were allowed or blocked
- An issuer cannot claim surprise at platform enforcement
- An admin cannot accidentally mutate investor history
- A public user cannot mistake information for solicitation

